@startuml 09-nat-traversal

skinparam backgroundColor #FFFFFF
skinparam defaultFontName "Helvetica"
skinparam defaultFontSize 12
skinparam shadowing false
skinparam RoundCorner 10
skinparam padding 4

title <b>NAT Traversal Techniques for P2P Connectivity</b>\nStrategies enabling direct peer connections through network barriers

skinparam rectangle {
  BackgroundColor<<peer>> #10B981
  FontColor<<peer>> #FFFFFF
  BorderColor<<peer>> #059669
  BackgroundColor<<nat>> #94A3B8
  FontColor<<nat>> #FFFFFF
  BorderColor<<nat>> #64748B
  BackgroundColor<<infra>> #3B82F6
  FontColor<<infra>> #FFFFFF
  BorderColor<<infra>> #2563EB
  BackgroundColor<<relay>> #8B5CF6
  FontColor<<relay>> #FFFFFF
  BorderColor<<relay>> #7C3AED
}

skinparam package {
  BackgroundColor #F8FAFC
  BorderColor #CBD5E1
  FontStyle bold
}

package "STUN: Discover Public Address" as STUN {
  rectangle "Peer A" as stun_a <<peer>>
  rectangle " NAT " as stun_nat <<nat>>
  rectangle "STUN\nServer" as stun_srv <<infra>>

  stun_a -[#3B82F6]-> stun_nat
  stun_nat -[#3B82F6]-> stun_srv : What's my IP?
  stun_srv -[#3B82F6,dashed]-> stun_nat : Your IP = 1.2.3.4
  stun_nat -[#3B82F6,dashed]-> stun_a
}

package "Hole Punching: Direct Connection" as HP {
  rectangle "Peer B" as hp_b <<peer>>
  rectangle "NAT B" as hp_natb <<nat>>
  rectangle "NAT C" as hp_natc <<nat>>
  rectangle "Peer C" as hp_c <<peer>>

  hp_b -[#10B981,bold]-> hp_natb
  hp_natb -[#10B981,bold]-> hp_natc : simultaneous open
  hp_natc -[#10B981,bold]-> hp_c
}

package "TURN: Relayed Connection" as TURN {
  rectangle "Peer D" as turn_d <<peer>>
  rectangle "TURN\nRelay" as turn_relay <<relay>>
  rectangle "Peer E" as turn_e <<peer>>

  turn_d -[#8B5CF6]-> turn_relay : send
  turn_relay -[#8B5CF6]-> turn_e : forward
  turn_e -[#8B5CF6,dashed]-> turn_relay : reply
  turn_relay -[#8B5CF6,dashed]-> turn_d : forward
}

note bottom
  **ICE (Interactive Connectivity Establishment)** coordinates these techniques:
  1. Try direct connection first
  2. Attempt STUN-assisted hole punching
  3. Fall back to TURN relay as last resort
end note
@enduml
