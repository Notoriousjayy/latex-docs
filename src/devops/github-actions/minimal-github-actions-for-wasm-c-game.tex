% minimal-github-actions-for-wasm-c-game.tex
% CI-safe: No minted, no Pygments, no shell-escape required
\documentclass[11pt]{article}

% === Encoding & Fonts ===
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\usepackage{microtype}

% === Page Layout ===
\usepackage[a4paper,margin=1in]{geometry}
\usepackage{parskip}
\usepackage{setspace}
\setstretch{1.08}

% === Colors ===
\usepackage{xcolor}
\definecolor{CodeBg}{HTML}{F9FAFB}
\definecolor{Ink}{HTML}{111827}
\definecolor{Accent}{HTML}{2563EB}

% === Hyperlinks ===
\usepackage{hyperref}
\usepackage{xurl}
\hypersetup{colorlinks=true, linkcolor=Accent, citecolor=Accent, urlcolor=Accent}

% === Lists ===
\usepackage{enumitem}
\setlist{itemsep=2pt, topsep=4pt, leftmargin=1.2em}

% === Code Blocks (listings only) ===
\usepackage{listings}
\usepackage{upquote}

\lstset{
  basicstyle=\ttfamily\footnotesize,
  backgroundcolor=\color{CodeBg},
  breaklines=true,
  columns=fullflexible,
  keepspaces=true,
  showstringspaces=false,
  frame=single,
  framerule=0.4pt,
  rulecolor=\color{Ink!30},
  tabsize=2,
  aboveskip=8pt,
  belowskip=8pt,
  xleftmargin=4pt,
  xrightmargin=4pt
}

\lstnewenvironment{bashcode}{\lstset{language=bash}}{}
\lstnewenvironment{yamlcode}{\lstset{}}{}
\lstnewenvironment{jsoncode}{\lstset{}}{}
\lstnewenvironment{textcode}{\lstset{}}{}

% === Silence missing .toc on first run ===
\makeatletter
\let\orig@starttoc\@starttoc
\def\@starttoc#1{\IfFileExists{\jobname.#1}{\orig@starttoc{#1}}{}}
\makeatother

% === Document ===
\title{\textbf{Comprehensive-Minimal GitHub Actions for a WASM C Game}}
\author{Emscripten + WebGL2 + CMake Presets (repo-tailored)}
\date{\today}

\begin{document}
\maketitle

\tableofcontents
\clearpage

\section{Executive Summary}

This guide delivers a cohesive, production-ready CI/CD baseline for a C/WebGL2 game compiled to WebAssembly via Emscripten. It is tailored for repositories that use \texttt{CMakePresets.json} with a \texttt{wasm-debug} configure preset that outputs to \texttt{build-wasm}.

The workflows form a minimal-yet-complete pipeline:
\begin{itemize}
  \item \textbf{Build \& Test}: Compile with Emscripten and your CMake preset
  \item \textbf{CodeQL (C/C++)}: Add SAST for C/C++ to catch issues in CI
  \item \textbf{Dependency Review}: Guard PRs by flagging risky changes
  \item \textbf{Deploy to GitHub Pages}: Publish for playtesting
  \item \textbf{Release on tags}: Package build artifacts as downloadable assets
\end{itemize}

\section{Quick Start}

\begin{enumerate}
  \item Ensure you have a \texttt{CMakePresets.json} with a \texttt{wasm-debug} configure preset that outputs to \texttt{build-wasm}.
  \item Push a branch: the \emph{Build \& Test} workflow compiles with Emscripten and caches dependencies.
  \item Open a PR: \emph{Dependency Review} and \emph{CodeQL} run as guardrails.
  \item Merge to \texttt{main}: \emph{Deploy to GitHub Pages} publishes a playable demo.
  \item Create a tag (e.g., \texttt{v0.1.0}): \emph{Release} packages WebAssembly assets.
\end{enumerate}

\section{Prerequisites}

\begin{itemize}
  \item \textbf{Emscripten SDK}: Installed and available on the runner via \texttt{emsdk}.
  \item \textbf{CMake presets}: A \texttt{CMakePresets.json} with a \texttt{wasm-debug} configure preset.
  \item \textbf{CI resources}: GitHub Actions enabled with permissions to read contents and write Pages.
  \item \textbf{Security scanning}: If using CodeQL, ensure GitHub Advanced Security is enabled.
\end{itemize}

\section{Repository Layout}

\begin{textcode}
notoriousjayy-wasm/
|-- readme.md
|-- CMakeLists.txt
|-- CMakePresets.json
|-- package.json
|-- html_template/
|   `-- index.html
|-- include/
|   `-- testProject/
|       |-- module.h
|       `-- render.h
`-- src/
    |-- main.c
    |-- module.c
    `-- render.c
\end{textcode}

\section{Workflow 1: Build \& Test}

\begin{yamlcode}
# .github/workflows/build-wasm.yml
name: Build (WASM C)
on:
  push: { branches: [main] }
  pull_request: { branches: [main] }

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      EMSDK: ${{ runner.temp }}/emsdk

    steps:
      - uses: actions/checkout@v4

      - name: Install Emscripten
        run: |
          git clone https://github.com/emscripten-core/emsdk.git "$EMSDK"
          "$EMSDK/emsdk" install latest
          "$EMSDK/emsdk" activate latest
          echo "EMSDK=$EMSDK" >> $GITHUB_ENV
          source "$EMSDK/emsdk_env.sh"
          emcc --version

      - name: Cache Emscripten
        uses: actions/cache@v4
        with:
          path: |
            ~/.emscripten_cache
            ${{ env.EMSDK }}/upstream/emscripten/cache
          key: emsdk-${{ runner.os }}-latest

      - name: Configure (emcmake + preset wasm-debug)
        run: |
          source "$EMSDK/emsdk_env.sh"
          emcmake cmake --preset wasm-debug

      - name: Build
        run: cmake --build --preset wasm-debug -j2

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-build
          path: |
            build-wasm/index.html
            build-wasm/index.js
            build-wasm/index.wasm
\end{yamlcode}

\section{Workflow 2: CodeQL}

\begin{yamlcode}
# .github/workflows/codeql.yml
name: CodeQL (C/C++)
on:
  push: { branches: [main] }
  pull_request: { branches: [main] }
  schedule: [{ cron: "0 6 * * 1" }]

permissions:
  contents: read
  security-events: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: cpp
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3
\end{yamlcode}

\section{Workflow 3: Dependency Review}

\begin{yamlcode}
# .github/workflows/dependency-review.yml
name: Dependency Review
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v4
\end{yamlcode}

\section{Workflow 4: Deploy to GitHub Pages}

\begin{yamlcode}
# .github/workflows/pages.yml
name: Deploy (GitHub Pages)
on:
  push: { branches: [main] }

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      EMSDK: ${{ runner.temp }}/emsdk
    steps:
      - uses: actions/checkout@v4
      - name: Install Emscripten
        run: |
          git clone https://github.com/emscripten-core/emsdk.git "$EMSDK"
          "$EMSDK/emsdk" install latest
          "$EMSDK/emsdk" activate latest
          source "$EMSDK/emsdk_env.sh"
      - name: Configure & build
        run: |
          emcmake cmake --preset wasm-debug
          cmake --build --preset wasm-debug -j2
          test -f build-wasm/index.html
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: build-wasm

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
\end{yamlcode}

\section{Workflow 5: Release on Tags}

\begin{yamlcode}
# .github/workflows/release.yml
name: Release
on:
  push:
    tags: ['v*.*.*']

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      EMSDK: ${{ runner.temp }}/emsdk
    steps:
      - uses: actions/checkout@v4
      - name: Install Emscripten
        run: |
          git clone https://github.com/emscripten-core/emsdk.git "$EMSDK"
          "$EMSDK/emsdk" install latest
          "$EMSDK/emsdk" activate latest
          source "$EMSDK/emsdk_env.sh"
      - name: Build
        run: |
          emcmake cmake --preset wasm-debug
          cmake --build --preset wasm-debug -j2
          (cd build-wasm && zip -r ../game-wasm.zip .)
      - uses: softprops/action-gh-release@v2
        with:
          files: game-wasm.zip
\end{yamlcode}

\section{Local Development}

\begin{bashcode}
# Emscripten SDK (once)
git clone https://github.com/emscripten-core/emsdk.git ~/emsdk
cd ~/emsdk && ./emsdk install latest && ./emsdk activate latest
source ~/emsdk/emsdk_env.sh

# Configure and build (matching README)
emcmake cmake --preset wasm-debug
cmake --build --preset wasm-debug

# Serve locally
cmake --build --preset wasm-debug --target serve
# Open http://localhost:8000/
\end{bashcode}

\section{Notes and Tips}

\begin{itemize}
  \item \textbf{Custom shell}: your \texttt{html\_template/index.html} already includes \texttt{\{\{\{ SCRIPT \}\}\}}, so the generated JS is injected correctly.
  \item \textbf{Exports}: CMake sets exported functions and runtime methods, so DevTools calls work out of the box.
  \item \textbf{Artifacts}: Pages and Release jobs upload the entire \texttt{build-wasm} directory.
  \item \textbf{Cache}: caching Emscripten cache speeds up builds.
  \item \textbf{Local serve target}: starts a Python HTTP server bound to configured host and port.
\end{itemize}

\section{Risks \& Mitigations}

\begin{itemize}
  \item \textbf{Stale caches}: Include cache keys derived from the preset and CMakeLists.txt hash.
  \item \textbf{Insufficient tests}: Add headless smoke tests and validate key exported functions.
  \item \textbf{Large bundle size}: Enable \texttt{-O3} for release, compress on publish.
  \item \textbf{CodeQL noise}: Triage to dismiss with reason or suppress safely.
  \item \textbf{Supply-chain drift}: Lock versions; review diffs; use Dependabot.
\end{itemize}

\section{Common Pitfalls}

\begin{itemize}
  \item \textbf{CodeQL not running}: Ensure GitHub Advanced Security is enabled.
  \item \textbf{Pages publish fails}: Confirm the \texttt{pages} and \texttt{id-token} permissions.
  \item \textbf{Emscripten not found}: Ensure \texttt{source "\$EMSDK/emsdk\_env.sh"} is called before \texttt{emcmake}.
\end{itemize}

\end{document}
