% codeql-cheatsheet.tex
% Compile with: pdflatex -shell-escape codeql-cheatsheet.tex
\documentclass[11pt]{article}

% ---------- Minted (CI-safe fallback) ----------
\usepackage{xparse}
\usepackage{iftex}
\usepackage{ifthen}

% Some repos run pdflatex without -shell-escape in CI.
% Use minted when shell-escape is enabled; otherwise fall back to listings.
\newif\ifciShellEscape
\ifdefined\pdfshellescape
  \ifnum\pdfshellescape=1\relax
    \ciShellEscapetrue
  \else
    \ciShellEscapefalse
  \fi
\else
  \ciShellEscapefalse
\fi

\ifciShellEscape
  \usepackage[newfloat,cache=false]{minted}
\else
  \usepackage{listings}
  \usepackage{newfloat}
  \DeclareFloatingEnvironment[fileext=lol, listname={List of Listings}, name=Listing]{listing}

  % Basic listings defaults (safe for UTF-8 text in code blocks)
  \lstset{
    basicstyle=\ttfamily\small,
    breaklines=true,
    breakatwhitespace=false,
    columns=fullflexible,
    keepspaces=true,
    showstringspaces=false,
    tabsize=2,
    frame=single,
    upquote=true,
    % Common Unicode glyphs seen in docs/snippets
    literate=
      {•}{{\textbullet}}1
      {–}{{--}}1
      {—}{{---}}1
      {→}{{$\rightarrow$}}1
      {←}{{$\leftarrow$}}1
  }

  % Define a few common "languages" so listings won't error
  \lstdefinelanguage{yaml}{} 
  \lstdefinelanguage{json}{} 
  \lstdefinelanguage{bash}{} 
  \lstdefinelanguage{console}{} 
  \lstdefinelanguage{powershell}{} 
  \lstdefinelanguage{markdown}{} 
  \lstdefinelanguage{text}{} 

  % minted compatibility shims (ignore minted-style options safely)
  \NewDocumentEnvironment{minted}{ O{} m }{%
    \def\minted@opts{#1}%
    \def\minted@lang{#2}%
    \ifthenelse{\begingroup\edef\temp{\minted@opts}\endgroup\in@{linenos}{\temp}\relax=1\relax}{%
      \lstset{numbers=left, numberstyle=\tiny, stepnumber=1, numbersep=6pt}%
    }{%
      \lstset{numbers=none}%
    }%
    \lstset{language=\minted@lang}%
    \begin{lstlisting}%
  }{%
    \end{lstlisting}%
  }

  \NewDocumentCommand{\mintinline}{ O{} m m }{\texttt{#3}}
  \NewDocumentCommand{\inputminted}{ O{} m m }{\lstinputlisting[language=#2]{#3}}

  \NewDocumentCommand{\setminted}{ O{} m }{}
  \NewDocumentCommand{\setmintedinline}{ O{} m }{}
  \NewDocumentCommand{\usemintedstyle}{ m }{}

  % \newminted{lang}{opts} -> defines an environment <lang>code
  \NewDocumentCommand{\newminted}{ m O{} }{%
    \NewDocumentEnvironment{#1code}{ O{} }{\begin{minted}{#1}}{\end{minted}}%
  }
  % \newmintedfile{lang}{opts} -> defines \input<lang>code{file}
  \NewDocumentCommand{\newmintedfile}{ m O{} }{%
    \expandafter\NewDocumentCommand\csname input#1code\endcsname{ m }{\inputminted{#1}{##1}}%
  }
\fi

% ---------- Fonts & page ----------
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\usepackage[a4paper,margin=0.9in]{geometry}
\usepackage{microtype}
\usepackage{parskip}

% ---------- Color & links ----------
\usepackage[dvipsnames]{xcolor}
\usepackage[hidelinks]{hyperref}

% ---------- Headings ----------
\usepackage{titlesec}
\titlespacing*{\section}{0pt}{6pt plus 2pt}{4pt}
\titlespacing*{\subsection}{0pt}{5pt plus 2pt}{3pt}

% ---------- Lists (fixes your error) ----------
\usepackage{enumitem}

% ---------- Boxes ----------
\usepackage[most]{tcolorbox}
\tcbset{
  sharp corners,
  colback=white,
  colframe=MidnightBlue,
  boxsep=4pt,
  left=8pt,right=8pt,top=6pt,bottom=6pt
}

% ---------- Code highlighting (minted) ----------
\usemintedstyle{friendly}
\setminted{cache=false,
  breaklines=true,
  breaksymbolleft=,
  breaksymbolright=,
  fontsize=\footnotesize,
  tabsize=2
}

% ---------- Title ----------
\makeatletter
\def\maketitle{
  \begin{center}
    {\LARGE \bfseries Code Scanning (CodeQL) — One-Page Cheat-Sheet\par}
    \vspace{2pt}
    {\small GitHub Actions + CodeQL quick setup, tips, and ready-to-use YAML\par}
  \end{center}\vspace{6pt}
}
\makeatother

% ---------- Silence first-run missing .toc (prevents strict latexmk aborts) ----------
\makeatletter
\let\ci@orig@starttoc\@starttoc
\def\@starttoc#1{%
  \begingroup
  \IfFileExists{\jobname.#1}{\ci@orig@starttoc{#1}}{}%
  \endgroup
}
\makeatother

\begin{document}
\maketitle

\begin{tcolorbox}
\textbf{What it is.} Code scanning (CodeQL) runs static analysis in CI to detect security issues and code quality problems. It builds or analyzes your code, creates a relational DB, and executes query packs. Supports common languages: C/C++, C\#, Go, Java, JavaScript/TypeScript, Python, Ruby.

\smallskip
\textbf{When to use.} Every PR and protected branch; schedule a weekly sweep. Triage alerts in PRs; fix or dismiss with a reason.

\smallskip
\textbf{Licensing.} Public repos: free. Private/internal: requires GHAS.
\end{tcolorbox}

\section*{Drop-in workflow: \texttt{.github/workflows/codeql.yml}}
\begin{minted}{yaml}
name: CodeQL

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: "0 8 * * 1"   # weekly, Mon 08:00 UTC
  workflow_dispatch: {}

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: codeql-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [ "cpp", "csharp", "go", "java", "javascript", "python", "ruby" ]

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # If not using a config file, you can select a suite here:
          # queries: security-extended

      # For compiled languages, try autobuild first.
      - name: Autobuild
        if: contains('cpp csharp go java', matrix.language)
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
\end{minted}

\section*{Optional advanced config: \texttt{.github/codeql/codeql-config.yml}}
\begin{minted}{yaml}
name: "CodeQL Advanced Config"

# Choose broader suites for depth:
# - security-extended
# - security-and-quality
queries:
  - uses: security-extended

packs:
  - github/codeql/cpp-queries@latest
  - github/codeql/javascript-queries@latest
  - github/codeql/python-queries@latest

paths:
  - src/
  - services/

paths-ignore:
  - "**/test/**"
  - "docs/**"
  - "**/*.md"
\end{minted}

\section*{10-step setup checklist}
\begin{enumerate}[leftmargin=1.1em,itemsep=2pt,topsep=2pt]
  \item Confirm GHAS for private/internal or use public repos.
  \item Add the workflow file above; commit on a feature branch and open a PR.
  \item (Optional) Add the advanced config and set your query suite.
  \item Scope triggers to protected branches; keep PR checks required.
  \item Ensure runners have resources; consider larger or self-hosted runners for heavy builds.
  \item Keep the \texttt{autobuild} step for compiled languages, or insert a custom build.
  \item Triage PR alerts: fix to auto-close, or dismiss with a reason.
  \item Pin actions to maintained major versions (e.g., \texttt{@v3}); use Dependabot to update.
  \item Control cost with schedules, manual dispatch, and \texttt{concurrency}.
  \item Monitor results in \textit{Security $\rightarrow$ Code scanning alerts}.
\end{enumerate}

\section*{Tips \& gotchas}
\begin{itemize}[leftmargin=1.1em,itemsep=2pt,topsep=2pt]
  \item \textbf{Compilation matters.} If your build needs env vars, services, or build tools, add those steps before \texttt{init/analyze}.
  \item \textbf{Language matrix.} Remove unused languages to speed up and lower cost.
  \item \textbf{Stable output.} Use consistent \texttt{paths} and \texttt{paths-ignore} to avoid noisy diffs.
  \item \textbf{Custom queries.} Host your own packs or add \texttt{queries:} entries for targeted checks.
  \item \textbf{Minted compile.} Compile with \texttt{-shell-escape} and have Python Pygments installed.
\end{itemize}

\end{document}
