\documentclass[11pt,a4paper]{article}

% --- Page + typography ---
\usepackage[a4paper,margin=1in]{geometry}
\usepackage{lmodern}            % Latin Modern fonts
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{microtype}          % better kerning/justification
\usepackage{parskip}            % space between paragraphs, no indents
\emergencystretch=2em

% --- Structure + lists ---
\usepackage{enumitem}
% Global spacing
\setlist{itemsep=2pt, topsep=4pt, leftmargin=1.2em}
% Ensure deep nesting works if needed
\setlistdepth{8}
\renewlist{itemize}{itemize}{8}
% ---- FIX: define safe labels for itemize levels to avoid "Undefined label" ----
\setlist[itemize,1]{label=\textbullet}
\setlist[itemize,2]{label=--}
\setlist[itemize,3]{label=\textasteriskcentered}
\setlist[itemize,4]{label=\tiny$\blacksquare$}
\setlist[itemize,5]{label=\textperiodcentered}
% ------------------------------------------------------------------------------
\usepackage{titlesec}
\titlespacing*{\section}{0pt}{6pt plus 2pt}{4pt}
\titlespacing*{\subsection}{0pt}{5pt}{3pt}
\titlespacing*{\subsubsection}{0pt}{4pt}{2pt}

% --- Color + links ---
\usepackage[dvipsnames]{xcolor}
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=black,
  urlcolor=MidnightBlue,
  citecolor=black,
  pdfauthor={Jordan Suber},
  pdftitle={Study Plan â€” OWASP API Security Top 10: User Stories Template}
}
\urlstyle{same}

% --- Math + symbols ---
\usepackage{amsmath,amssymb}

% --- Layout helpers for story cards ---
\usepackage[skins,breakable]{tcolorbox}
\tcbset{
  colback=gray!2,
  colframe=gray!50,
  arc=2pt,
  boxrule=0.4pt,
  left=8pt,right=8pt,top=8pt,bottom=8pt,
  enhanced jigsaw
}
\usepackage{tabularx}
\usepackage{array}
\usepackage{ragged2e}

% --- Readability helpers for cards ---
\newcolumntype{L}[1]{>{\raggedleft\arraybackslash\bfseries}p{#1}}
\newcolumntype{Y}{>{\RaggedRight\arraybackslash}X}
\newtcbox{\pill}{on line, arc=3pt, boxsep=0.8pt, left=4pt,right=4pt,top=1pt,bottom=1pt,
  colframe=gray!50, colback=gray!15, boxrule=0.3pt}
\newcommand{\badge}[1]{\pill{\footnotesize #1}}

% --- Shortcuts/labels ---
\newcommand{\cb}{\(\square\)}
\newcommand{\DoR}{\textbf{Definition of Ready:} Persona clear; AC drafted; Dependencies known; Estimate set.}
\newcommand{\DoD}{\textbf{Definition of Done:} All ACs pass; Tests green; Security checks; Docs updated; Deployed/flagged.}
\newcommand{\Priority}[1]{\textbf{Priority:} #1}

% --- Story Card macro (9 args) ---
% 1: ID 2: Title 3: Epic/Feature 4: Business Value
% 5: Priority 6: Estimate(SP) 7: Persona 8: Dependencies 9: Assumptions/Risks
\newcommand{\StoryCard}[9]{%
\newpage
\begin{tcolorbox}[
  enhanced, breakable,
  colback=gray!2, colframe=gray!50, arc=2pt, boxrule=0.4pt,
  left=8pt,right=8pt,top=8pt,bottom=8pt,
  fonttitle=\bfseries\large,
  title={\textbf{#1}\ \textemdash\ #2},
  colbacktitle=gray!6, coltitle=black,
  borderline west={2pt}{0pt}{MidnightBlue}
]
\small
\begin{tabularx}{\textwidth}{@{}L{3.2cm}Y@{}}
Epic / Feature       & #3 \\
Business Value       & #4 \\
Priority / Estimate  & \badge{Priority: #5}\ \badge{SP: #6} \\
Persona              & #7 \\
Dependencies         & #8 \\
Assumptions / Risks  & #9 \\
\end{tabularx}

\medskip
\textbf{Story}\quad \emph{As a #7, I want to #2 so that #4.}

\medskip
\textbf{Non-Functional}\quad
\badge{Security}\ \badge{Performance}\ \badge{Reliability}\ \badge{Privacy}\ \badge{Observability}

\medskip
\textbf{Acceptance Criteria (Generic, BDD)}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm, style=nextline, itemsep=2pt, topsep=2pt]
  \item[\textbf{Scenario}] Outcome is evidenced in CI
  \item[\textbf{Given}] the target API, spec, and test environment are available
  \item[\textbf{When}] the tasks below are implemented and tests are executed in CI
  \item[\textbf{Then}] the stated outcome is observable in reports, logs, and job summary
\end{description}

\vspace{0.2\baselineskip}
{\footnotesize\color{gray!60}\DoR\ \textbullet\ \DoD}
\end{tcolorbox}
}

% --- Lightweight Tasks box for every story ---
% Usage: \begin{TasksBox} ... \end{TasksBox}
% Optional title: \begin{TasksBox}[Pre-Deployment Tasks] ... \end{TasksBox}
\newenvironment{TasksBox}[1][Tasks]{%
\begin{tcolorbox}[
  enhanced,breakable,
  colback=gray!1, colframe=gray!35,
  colbacktitle=gray!6, coltitle=black,
  title={#1}, fonttitle=\bfseries,
  borderline west={1.8pt}{0pt}{MidnightBlue},
  arc=2pt, boxrule=0.4pt,
  left=10pt,right=10pt,top=6pt,bottom=6pt,
  before skip=6pt, after skip=10pt
]
\small
\begin{itemize}[
  label=\cb, leftmargin=*, labelsep=0.6em,
  itemsep=4pt, topsep=2pt, parsep=0pt
]
}{%
\end{itemize}
\end{tcolorbox}
}

% --- Title ---
\title{Study Plan --- OWASP API Security Top 10\\\large A User Stories Template for Practical Mastery}
\author{Compiled for Jordan Suber}
\date{}

\begin{document}
\maketitle
\tableofcontents
\newpage

\section*{How to Use This Template}
Each card below turns an OWASP API Top 10 (2023) risk into an actionable user story with tasks and verifiable outcomes. Copy any card into your backlog and adjust fields (\emph{Persona}, \emph{Dependencies}, estimates) to your context. Keep stories INVEST-compliant and attach evidence (reports, logs) to each PR/build.
\medskip

\noindent\textbf{References.} OWASP API Security Top 10 (2023): API1--API10. See \url{https://owasp.org/www-project-api-security/} for canonical definitions and guidance.

\section{Writing Effective User Stories (Quick Primer)}
\subsection*{Required Story Data}
\begin{itemize}
  \item \textbf{Epic/Feature} (traceability), \textbf{Business Value} (why it matters), \textbf{Priority}, \textbf{Estimate (SP)}, \textbf{Persona}, \textbf{Dependencies}, \textbf{Assumptions/Risks}.
  \item \textbf{Acceptance Criteria} written in BDD form (Given/When/Then), observable in CI or runtime telemetry.
  \item \textbf{Evidence} links: build artifacts, scanner reports, dashboards, and test logs.
\end{itemize}

\subsection*{INVEST Heuristics}
\begin{itemize}
  \item \textbf{Independent:} avoids cross-team blocking.
  \item \textbf{Negotiable:} scope can be right-sized.
  \item \textbf{Valuable:} risk reduced, compliance improved, or time saved.
  \item \textbf{Estimable:} bounded by clear AC and DoD.
  \item \textbf{Small:} completes within a sprint (1--5 SP typical).
  \item \textbf{Testable:} pass/fail can be automated.
\end{itemize}

\subsection*{Good AC Patterns (Examples)}
\begin{itemize}
  \item \textbf{Given} a user with token \texttt{A} and another user's object ID, \textbf{When} the GET is attempted, \textbf{Then} the API returns \texttt{403} and logs an authZ denial with subject/object IDs.
  \item \textbf{Given} login endpoint, \textbf{When} 30 requests are sent within 10s from one IP, \textbf{Then} rate limiter returns \texttt{429} with retry headers and no auth state change.
\end{itemize}

\newpage
\section{Kickoff \& Lab Setup}
\StoryCard{W0-Setup}{establish a practice repo and CI scaffolding}{Enablement / Foundations}
{Create a safe space to iterate on risks with automated evidence and reproducibility}
{Must}{3}{security champion}{VCS, CI runner, sample API}
{Tooling install time; align languages and package managers across team}

\begin{TasksBox}[Setup Tasks]
  \item Initialize repo structure: \texttt{/openapi}, \texttt{/tests}, \texttt{/policies}, \texttt{/load}, \texttt{/docs}.
  \item Add CI workflow: lint spec (Spectral), run unit tests, publish artifacts and job summary.
  \item Choose a vulnerable demo API \emph{and} a greenfield API you control.
  \item Seed \texttt{README.md} with architecture diagram, risk register, and Definition of Done (Security).
\end{TasksBox}

\subsection*{Risk-Specific AC for Setup}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] CI is configured for the repo
  \item[\textbf{When}] a PR updates tests/spec
  \item[\textbf{Then}] CI emits a summary linking to lint, unit, and coverage reports with pass/fail status
\end{description}

% ---------- API1 ----------
\section{API1 --- Broken Object Level Authorization (BOLA)}
\StoryCard{API1-BOLA}{enforce object-level authorization checks}{Access Control}
{Prevent cross-tenant and cross-user data exposure and tampering}
{Must}{5}{backend engineer}{User/tenant model, auth context in handlers}
{Legacy endpoints may bypass middleware; map all object IDs and owners first}

\begin{TasksBox}[Tasks]
  \item Inventory resources and ownership (subject$\rightarrow$object) per endpoint; record in a matrix.
  \item Implement server-side ownership checks in controllers/middleware for \texttt{GET/PUT/PATCH/DELETE}.
  \item Add negative tests that swap IDs in path/body/query to simulate IDOR.
  \item Log authZ decisions with subject, object, policy, and outcome; redact PII.
  \item Fail CI if any endpoint lacks an ownership test.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] user \texttt{A} and user \texttt{B} exist with distinct object IDs
  \item[\textbf{When}] \texttt{A} requests \texttt{/objects/\{id\_B\}}
  \item[\textbf{Then}] response is \texttt{403} and audit log contains a denied authZ entry with subject/object mapping
\end{description}

% ---------- API5 ----------
\section{API5 --- Broken Function Level Authorization (BFLA)}
\StoryCard{API5-BFLA}{enforce action/role checks for functions}{Access Control}
{Stop privilege escalation and unauthorized state changes}
{Must}{5}{service owner}{RBAC/ABAC policy store, role catalog}
{Hidden/legacy admin endpoints; surface and block}
\begin{TasksBox}[Tasks]
  \item Build role$\rightarrow$action matrix (list/create/update/delete/admin) per endpoint.
  \item Block undocumented endpoints by default; return \texttt{404} or \texttt{403} as policy.
  \item Add tests that attempt admin-only actions with basic user tokens.
  \item Emit structured authZ logs for each action decision.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] a basic role token
  \item[\textbf{When}] calling \texttt{POST /admin/users}
  \item[\textbf{Then}] API returns \texttt{403}, no side-effects occur, and a denial is recorded
\end{description}

% ---------- API3 ----------
\section{API3 --- Broken Object Property Level Authorization (BOPLA)}
\StoryCard{API3-BOPLA}{restrict access to sensitive fields}{Data Protection}
{Ensure only authorized roles see/modify protected properties}
{Must}{5}{API developer}{DTO/serializer layer, field visibility rules}
{Client filtering is insufficient; enforce on the server}
\begin{TasksBox}[Tasks]
  \item Define field visibility per role (e.g., \texttt{ssn}, \texttt{isAdmin}, secrets).
  \item Implement server-side projection via DTO/serializers or GraphQL resolvers.
  \item Add tests asserting sensitive fields never appear for unauthorized roles.
  \item Create write-guards to block updates to restricted fields.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] a basic user token
  \item[\textbf{When}] fetching \texttt{/users/me}
  \item[\textbf{Then}] response excludes \texttt{ssn} and \texttt{isAdmin}; schemas validate absence
\end{description}

% ---------- API2 ----------
\section{API2 --- Broken Authentication}
\StoryCard{API2-Auth}{harden authentication and sessions}{Identity \& Sessions}
{Reduce account takeover and token abuse by enforcing strong auth flows}
{Must}{5}{platform engineer}{OAuth2/OIDC or session service, keys/rotation}
{Token validation gaps; ensure \texttt{exp/aud/iss/nbf} checks}
\begin{TasksBox}[Tasks]
  \item Standardize on OIDC/OAuth2 or signed sessions; rotate signing keys.
  \item Enforce MFA where appropriate; rate limit login \& password reset flows.
  \item Validate JWT claims and implement secure refresh; prevent replay.
  \item Add failed-login correlation logs and alerting.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] 30 login attempts from one IP within 10s
  \item[\textbf{When}] the attempts are executed
  \item[\textbf{Then}] API returns \texttt{429} with retry headers; no session is established
\end{description}

% ---------- API4 ----------
\section{API4 --- Unrestricted Resource Consumption}
\StoryCard{API4-URC}{apply quotas, limits, and pagination}{Availability}
{Protect availability and reduce noisy-neighbor effects}
{Must}{5}{SRE}{Gateway/limiter, pagination patterns}
{Large payloads and expensive queries must be controlled}
\begin{TasksBox}[Tasks]
  \item Define per-endpoint budgets (RPS, burst, concurrency, body size).
  \item Implement pagination and filters; add \texttt{413} on oversize payloads.
  \item Load-test abusive patterns (k6/Locust); verify graceful \texttt{429}.
  \item Dashboards: success/4xx/5xx, rate-limit hits, latency p95/p99.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] a client exceeds the configured RPS for \texttt{/search}
  \item[\textbf{When}] requests continue beyond the burst window
  \item[\textbf{Then}] responses are \texttt{429} with \texttt{Retry-After} and no resource exhaustion occurs
\end{description}

% ---------- API6 ----------
\section{API6 --- Unrestricted Access to Sensitive Business Flows}
\StoryCard{API6-Flows}{protect high-value flows from automation abuse}{Abuse Mitigation}
{Prevent fraud/abuse in money/credit/referral flows}
{Must}{5}{product security}{Risk catalog, friction controls}
{Balance friction vs.\ false positives with telemetry}
\begin{TasksBox}[Tasks]
  \item Identify sensitive flows; tag endpoints in OpenAPI with risk annotations.
  \item Add friction: velocity rules, step-up auth, proof-of-work, or device signals.
  \item Simulate abuse; measure precision/recall of detections.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] 5 coupon redemptions within 60s by same account/IP
  \item[\textbf{When}] the 6th attempt occurs
  \item[\textbf{Then}] flow is blocked or requires step-up auth; event is logged and alerted
\end{description}

% ---------- API7 ----------
\section{API7 --- Server-Side Request Forgery (SSRF)}
\StoryCard{API7-SSRF}{constrain server egress driven by user input}{Network Egress}
{Block pivoting to internal services and metadata endpoints}
{Must}{5}{platform engineer}{Egress proxy, allow-list, DNS re-resolution}
{Disable raw URL fetches; sanitize and validate destinations}
\begin{TasksBox}[Tasks]
  \item Route outbound HTTP via proxy; enforce allow-list and DNS re-resolution.
  \item Block RFC1918/localhost/metadata IP ranges.
  \item Add tests attempting to reach \texttt{169.254.169.254} and internal hosts.
  \item Log denials with destination details; alert on patterns.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] an endpoint accepting a URL
  \item[\textbf{When}] a URL targeting \texttt{169.254.169.254} is submitted
  \item[\textbf{Then}] request is denied and logged; no egress connection occurs
\end{description}

% ---------- API8 ----------
\section{API8 --- Security Misconfiguration}
\StoryCard{API8-Misconfig}{standardize secure defaults and hardening}{Hardening}
{Reduce attack surface via configs, headers, and container hygiene}
{Must}{5}{devops}{Baseline headers, pinned images, minimal privileges}
{Config drift; codify checks in CI}
\begin{TasksBox}[Tasks]
  \item Enforce TLS and baseline headers (CORS, HSTS where applicable); minimize error leakage.
  \item Pin container images; drop root privileges; read-only FS where possible.
  \item Scan IaC/images (Trivy, tfsec); fail on new high/critical.
  \item Create a golden service template with secure defaults.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] a new service scaffolded from the template
  \item[\textbf{When}] CI runs
  \item[\textbf{Then}] baseline header tests pass and image/IaC scans report no high/critical issues
\end{description}

% ---------- API9 ----------
\section{API9 --- Improper Inventory Management}
\StoryCard{API9-Inventory}{maintain authoritative API inventory and lifecycle}{Governance}
{Know every API/version/owner to reduce shadow risk}
{Must}{5}{platform owner}{API catalog/CMDB, gateway logs}
{Rogue endpoints; auto-discovery required}
\begin{TasksBox}[Tasks]
  \item Build/extend API catalog with version, owner, data classification, lifecycle.
  \item Auto-register services from CI on build/release.
  \item Detect shadow endpoints via gateway logs and repo search.
  \item Publish deprecation schedules and retirement runbooks.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] a new service is released
  \item[\textbf{When}] CI completes
  \item[\textbf{Then}] the service appears in the catalog with owner, version, and classification
\end{description}

% ---------- API10 ----------
\section{API10 --- Unsafe Consumption of APIs}
\StoryCard{API10-Consumption}{treat upstream APIs as untrusted}{Third-Party Risk}
{Prevent cascading failures and data misuse from dependencies}
{Must}{5}{integration engineer}{Timeouts/retries/circuit breakers, schema validation}
{Provider changes; contract tests mitigate}
\begin{TasksBox}[Tasks]
  \item Validate upstream responses against JSON Schema; reject on drift.
  \item Configure short timeouts, bounded retries, circuit breakers, and fallbacks.
  \item Add consumer-driven contract tests in CI; pin scopes/permissions.
  \item Maintain SBOM of integrations and usage terms.
\end{TasksBox}

\subsection*{Risk-Specific AC}
\begin{description}[leftmargin=2.4cm, labelwidth=2.3cm]
  \item[\textbf{Given}] the upstream adds a new required field
  \item[\textbf{When}] contract tests run in CI
  \item[\textbf{Then}] the build fails with a clear schema diff and no production deploy occurs
\end{description}

% ---------- Cross-cutting ----------
\section{Cross-Cutting Practices (Do Weekly)}
\begin{TasksBox}[Ongoing Tasks]
  \item Update threat models (DFDs, misuse cases) with each change; link to PRs.
  \item Standardize structured logs: auth decisions, rate-limit hits, SSRF denials.
  \item Export scanner and test reports (HTML/JSON) as build artifacts.
  \item Review dashboards (latency p95/p99, \% 4xx/5xx) and error budgets.
\end{TasksBox}

% ---------- Capstone ----------
\section{Capstone Exercise}
\StoryCard{CAP-RedBlue}{run a red/blue exercise across API1--API10}{Readiness}
{Prove detection, response, and hardening in realistic attack flows}
{Must}{8}{security team}{Staging env, attack scripts, runbooks}
{Time-box per scenario; record lessons and backlog follow-ups}
\begin{TasksBox}[Tasks]
  \item Simulate BOLA/BOPLA/BFLA/SSRF and business-flow abuse; capture evidence.
  \item Execute response playbooks (block patterns, rate limits, feature flags).
  \item Produce a post-mortem with top 5 improvements and owners.
\end{TasksBox}

\section*{Checklist Snapshot (Printable)}
\begin{itemize}[label=\cb]
  \item API spec linted; security schemes, schemas constrained.
  \item Ownership/role/field matrices exist with passing tests.
  \item Rate limits, quotas, and pagination verified under load.
  \item Egress proxy + allow-list; SSRF denials logged and alerted.
  \item Golden service template with scans and secure defaults.
  \item API catalog up to date; deprecation schedules published.
  \item Third-party contracts tested; timeouts/retries/circuit breakers configured.
\end{itemize}

\end{document}
