name: Render PlantUML diagrams

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "src/**/*.puml"
      - ".github/workflows/render-plantuml.yml"

jobs:
  render:
    runs-on: ubuntu-latest

    # Avoid infinite loops when the workflow auto-commits generated images.
    if: github.actor != 'github-actions[bot]'

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install PlantUML + Graphviz
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends             plantuml graphviz default-jre-headless

      - name: Render all .puml files to png/svg/jpg (per-directory)
        shell: bash
        run: |
          set -euo pipefail

          ROOT="src"
          CONFIG_NAMES=("plantuml-config.puml" "config.puml")
          FORMATS=("png" "svg" "jpg")

          find_config() {
            local start_dir="$1"
            local d="$start_dir"
            while true; do
              for n in "${CONFIG_NAMES[@]}"; do
                if [[ -f "${d}/${n}" ]]; then
                  echo "${d}/${n}"
                  return 0
                fi
              done
              [[ "$d" == "$ROOT" ]] && break
              d="$(dirname "$d")"
            done
            echo ""
          }

          # Collect .puml files (excluding config files).
          mapfile -d '' PUMLS < <(
            find "$ROOT" -type f -name "*.puml"               ! -name "plantuml-config.puml"               ! -name "config.puml"               -print0
          )

          if [[ ${#PUMLS[@]} -eq 0 ]]; then
            echo "No PlantUML files found under ${ROOT}/"
            exit 0
          fi

          SUMMARY="plantuml-render-summary.md"
          {
            echo "# PlantUML Render Summary"
            echo
            echo "- Render time (UTC): $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo "- Files discovered: ${#PUMLS[@]}"
            echo
          } > "$SUMMARY"

          for puml in "${PUMLS[@]}"; do
            dir="$(dirname "$puml")"
            base="$(basename "$puml" .puml)"
            cfg="$(find_config "$dir")"

            mkdir -p "${dir}/png" "${dir}/svg" "${dir}/jpg"
            echo "Rendering: ${puml}"

            {
              echo "## \`${puml}\`"
              if [[ -n "$cfg" ]]; then
                echo "- Config: \`${cfg}\`"
              else
                echo "- Config: _(none)_"
              fi
              echo "- Outputs:"
            } >> "$SUMMARY"

            for fmt in "${FORMATS[@]}"; do
              # Render into a per-diagram temp directory to avoid name collisions, then rename to match the .puml filename.
              tmp=".plantuml-tmp/${base}/${fmt}"
              mkdir -p "${dir}/${tmp}"

              # Absolute path for config to avoid path issues when we cd into the diagram directory.
              if [[ -n "$cfg" ]]; then
                cfg_abs="$(python3 - <<'PY'
import os, sys
print(os.path.abspath(sys.argv[1]))
PY
"$cfg")"
              else
                cfg_abs=""
              fi

              pushd "$dir" >/dev/null
              if [[ -n "$cfg_abs" ]]; then
                plantuml "-t${fmt}" -o "${tmp}" -config "${cfg_abs}" "$(basename "$puml")"
              else
                plantuml "-t${fmt}" -o "${tmp}" "$(basename "$puml")"
              fi
              popd >/dev/null

              dest_dir="${dir}/${fmt}"
              ext="${fmt}"

              produced=""
              if [[ "$fmt" == "jpg" ]]; then
                if compgen -G "${dir}/${tmp}/*.jpg" > /dev/null; then
                  produced="$(ls -1 "${dir}/${tmp}/"*.jpg | head -n 1)"
                elif compgen -G "${dir}/${tmp}/*.jpeg" > /dev/null; then
                  produced="$(ls -1 "${dir}/${tmp}/"*.jpeg | head -n 1)"
                  ext="jpg"
                fi
              else
                if compgen -G "${dir}/${tmp}/*.${ext}" > /dev/null; then
                  produced="$(ls -1 "${dir}/${tmp}/"*.${ext} | head -n 1)"
                fi
              fi

              if [[ -z "$produced" ]]; then
                echo "ERROR: No output produced for ${puml} (format=${fmt})"
                exit 1
              fi

              dest="${dest_dir}/${base}.${ext}"
              mv -f "$produced" "$dest"
              rm -rf "${dir}/.plantuml-tmp/${base}/${fmt}"

              echo "  - ${fmt}: \`${dest}\`" >> "$SUMMARY"
            done

            echo >> "$SUMMARY"
          done

      - name: Auto-commit rendered images
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore(diagrams): render PlantUML images"
          file_pattern: |
            plantuml-render-summary.md
            src/**/png/*.png
            src/**/svg/*.svg
            src/**/jpg/*.jpg
