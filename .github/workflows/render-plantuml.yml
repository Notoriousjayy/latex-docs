# .github/workflows/render-plantuml.yml
# Standalone workflow to render PlantUML diagrams and commit back
# Also usable as a reusable workflow
name: Render PlantUML Diagrams

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      commit-changes:
        description: 'Commit rendered images back to repo'
        type: boolean
        default: true
  push:
    branches: [main]
    paths:
      - 'src/**/*.puml'
      - '!src/**/png/*'
      - '!src/**/svg/*'
      - '!src/**/jpg/*'
      - '.github/workflows/render-plantuml.yml'

# Prevent infinite loops from auto-commits
concurrency:
  group: plantuml-${{ github.ref }}
  cancel-in-progress: true

jobs:
  render:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Render PlantUML diagrams
        uses: ./.github/actions/render-plantuml
        with:
          source-dir: src
          formats: 'png svg'

      - name: Generate render summary
        run: |
          SUMMARY="plantuml-render-summary.md"
          
          {
            echo "# PlantUML Render Summary"
            echo ""
            echo "- Run: ${{ github.run_id }}"
            echo "- Commit: ${{ github.sha }}"
            echo "- Timestamp (UTC): $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo ""
            echo ""
            echo "## Files processed"
            echo ""
            
            find src -type f -name "*.puml" | while read -r puml; do
              base=$(basename "$puml" .puml)
              if [[ "$base" == "plantuml-config" || "$base" == "config" ]]; then
                echo "- ⏭️  $puml (config)"
              else
                echo "- ✅  $puml"
              fi
            done
            
            echo ""
            echo "## Totals"
            echo ""
            rendered=$(find src -type f -name "*.puml" ! -name "*config*.puml" | wc -l)
            skipped=$(find src -type f -name "*config*.puml" | wc -l)
            echo "- Rendered: $rendered"
            echo "- Skipped:  $skipped"
            echo "- Failed:   0"
          } > "$SUMMARY"

      - name: Auto-commit rendered images
        if: inputs.commit-changes != false
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(diagrams): render PlantUML images'
          file_pattern: |
            plantuml-render-summary.md
            src/**/png/*.png
            src/**/svg/*.svg
