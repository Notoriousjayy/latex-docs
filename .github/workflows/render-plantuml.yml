name: Render PlantUML diagrams

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "src/**/*.puml"
      - "src/common/plantuml-config.puml"
      - ".github/workflows/render-plantuml.yml"

jobs:
  render:
    runs-on: ubuntu-latest

    # Avoid infinite loops when the workflow auto-commits generated images.
    if: github.actor != 'github-actions[bot]'

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre graphviz imagemagick

      - name: Download PlantUML
        run: |
          mkdir -p ~/.local/bin
          curl -fsSL -o ~/.local/bin/plantuml.jar \
            https://github.com/plantuml/plantuml/releases/download/v1.2024.7/plantuml-1.2024.7.jar

      - name: Render PlantUML diagrams
        shell: bash
        run: |
          set -euo pipefail

          CONFIG_FILE="src/common/plantuml-config.puml"
          CONFIG_ARG=()
          if [[ -f "$CONFIG_FILE" ]]; then
            CONFIG_ARG=(-config "$CONFIG_FILE")
          else
            echo "WARN: PlantUML config not found at: $CONFIG_FILE (continuing without -config)"
          fi

          # Find all .puml files in src/ (excluding the config file itself)
          while IFS= read -r -d '' puml_file; do
            if [[ "$puml_file" == "$CONFIG_FILE" ]]; then
              continue
            fi

            dir="$(dirname "$puml_file")"
            base="$(basename "$puml_file")"
            name="${base%.puml}"

            echo "Processing: $puml_file"

            mkdir -p "$dir/png" "$dir/svg" "$dir/jpg"

            # Run from the diagram directory so output paths are predictable
            ( cd "$dir" && \
              java -jar "$HOME/.local/bin/plantuml.jar" \
                "${CONFIG_ARG[@]}" \
                -tpng -o png \
                "$base" )

            ( cd "$dir" && \
              java -jar "$HOME/.local/bin/plantuml.jar" \
                "${CONFIG_ARG[@]}" \
                -tsvg -o svg \
                "$base" )

            # Convert PNG to JPG (if produced)
            if [[ -f "$dir/png/$name.png" ]]; then
              convert "$dir/png/$name.png" -quality 92 "$dir/jpg/$name.jpg"
            fi

            echo "  -> Generated: $dir/{png,svg,jpg}/$name.*"
          done < <(find src -type f -name '*.puml' -print0)

          echo ""
          echo "=== Render Summary ==="
          echo "PNG files: $(find src -path '*/png/*.png' -type f | wc -l)"
          echo "SVG files: $(find src -path '*/svg/*.svg' -type f | wc -l)"
          echo "JPG files: $(find src -path '*/jpg/*.jpg' -type f | wc -l)"

          echo ""
          echo "=== Git Status (debug) ==="
          git status --porcelain || true

          # If files are being ignored, this will explain why (limit to first 50)
          mapfile -t CANDIDATES < <(
            find src -type f \( -path '*/png/*.png' -o -path '*/svg/*.svg' -o -path '*/jpg/*.jpg' \) \
              2>/dev/null | head -n 50
          )
          if (( ${#CANDIDATES[@]} > 0 )); then
            git check-ignore -v "${CANDIDATES[@]}" || true
          fi

      # Auto-commit rendered outputs back to repo
      - name: Commit rendered diagrams
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore(diagrams): render PlantUML diagrams"
          # Use Git pathspec glob-magic so recursive patterns reliably match
          file_pattern: ":(glob)src/**/png/*.png :(glob)src/**/svg/*.svg :(glob)src/**/jpg/*.jpg"
