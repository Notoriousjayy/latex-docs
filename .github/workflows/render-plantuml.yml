name: Render PlantUML diagrams

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "src/**/*.puml"
      - "src/common/plantuml-config.puml"
      - ".github/workflows/render-plantuml.yml"

jobs:
  render:
    runs-on: ubuntu-latest

    # Avoid infinite loops when the workflow auto-commits generated images.
    if: github.actor != 'github-actions[bot]'

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre graphviz imagemagick

      - name: Download PlantUML
        run: |
          mkdir -p ~/.local/bin
          curl -L -o ~/.local/bin/plantuml.jar \
            https://github.com/plantuml/plantuml/releases/download/v1.2024.7/plantuml-1.2024.7.jar

      - name: Render PlantUML diagrams
        run: |
          set -euo pipefail

          CONFIG_FILE="src/common/plantuml-config.puml"
          CONFIG_ARG=""
          if [[ -f "$CONFIG_FILE" ]]; then
            CONFIG_ARG="-config $CONFIG_FILE"
          fi

          # Find all .puml files in src/ (excluding the config file)
          while IFS= read -r -d '' puml_file; do
            # Skip the config file itself
            if [[ "$puml_file" == "$CONFIG_FILE" ]]; then
              continue
            fi

            dir="$(dirname "$puml_file")"
            filename="$(basename "$puml_file" .puml)"

            echo "Processing: $puml_file"

            # Create format-specific output directories
            mkdir -p "$dir/png" "$dir/svg" "$dir/jpg"

            # Render PNG
            java -jar ~/.local/bin/plantuml.jar \
              $CONFIG_ARG \
              -tpng \
              -o "$(pwd)/$dir/png" \
              "$puml_file"

            # Render SVG
            java -jar ~/.local/bin/plantuml.jar \
              $CONFIG_ARG \
              -tsvg \
              -o "$(pwd)/$dir/svg" \
              "$puml_file"

            # Convert PNG to JPG
            if [[ -f "$dir/png/$filename.png" ]]; then
              convert "$dir/png/$filename.png" -quality 92 "$dir/jpg/$filename.jpg"
            fi

            echo "  -> Generated: $dir/{png,svg,jpg}/$filename.*"

          done < <(find src -type f -name '*.puml' -print0)

          # Summary
          echo ""
          echo "=== Render Summary ==="
          echo "PNG files: $(find src -path '*/png/*.png' -type f | wc -l)"
          echo "SVG files: $(find src -path '*/svg/*.svg' -type f | wc -l)"
          echo "JPG files: $(find src -path '*/jpg/*.jpg' -type f | wc -l)"

      # Auto-commit rendered outputs back to repo
      - name: Commit rendered diagrams
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(diagrams): render PlantUML diagrams"
          file_pattern: "src/**/png/* src/**/svg/* src/**/jpg/*"