# .github/workflows/plantuml-render-ci.yml
# ============================================================================
# UNIFIED PLANTUML CI WORKFLOW
# ============================================================================
# Single workflow for both:
#   - PRs â†’ Render + Validate only (no commit)
#   - Push to main â†’ Render + Commit back to repo
#
# This eliminates logic duplication by using the single render-plantuml action.
# ============================================================================
name: PlantUML Render CI

on:
  workflow_dispatch:
    inputs:
      commit-changes:
        description: 'Commit rendered images back to repo'
        type: boolean
        default: true
      generate-jpg:
        description: 'Generate JPG files from PNG'
        type: boolean
        default: false
  pull_request:
    paths:
      - 'src/**/*.puml'
      - '.github/actions/render-plantuml/**'
      - '.github/workflows/plantuml-render-ci.yml'
  push:
    branches: [main]
    paths:
      - 'src/**/*.puml'
      - '.github/actions/render-plantuml/**'
      - '.github/workflows/plantuml-render-ci.yml'

concurrency:
  group: plantuml-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # ============================================================================
  # Single render job - used for both validation and commit scenarios
  # ============================================================================
  render:
    runs-on: ubuntu-latest
    # Skip if triggered by the bot's own commits to prevent loops
    if: github.actor != 'github-actions[bot]'

    outputs:
      has-changes: ${{ steps.plantuml.outputs.has_changes }}
      diagram-count: ${{ steps.plantuml.outputs.diagram_count }}
      rendered-count: ${{ steps.plantuml.outputs.rendered_count }}
      failed-count: ${{ steps.plantuml.outputs.failed_count }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          # Use a token with write access for commits
          token: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------------
      # Use the SINGLE render unit (DRY - no duplicate logic)
      # ----------------------------------------------------------------
      - name: Render PlantUML diagrams
        id: plantuml
        uses: ./.github/actions/render-plantuml
        with:
          source-dir: 'src'
          formats: 'png svg'
          generate-jpg: ${{ inputs.generate-jpg || 'false' }}
          fail-on-error: 'true'

      # ----------------------------------------------------------------
      # Verify outputs (for both PR and push scenarios)
      # ----------------------------------------------------------------
      - name: Verify rendered outputs
        run: |
          echo "=== Render Results ==="
          echo "Diagrams found: ${{ steps.plantuml.outputs.diagram_count }}"
          echo "Files rendered: ${{ steps.plantuml.outputs.rendered_count }}"
          echo "Failures: ${{ steps.plantuml.outputs.failed_count }}"
          echo "Has changes: ${{ steps.plantuml.outputs.has_changes }}"
          echo ""
          
          echo "=== PNG Files ==="
          find src -path "*/png/*.png" -type f 2>/dev/null | wc -l
          
          echo ""
          echo "=== SVG Files ==="
          find src -path "*/svg/*.svg" -type f 2>/dev/null | wc -l
          
          # Show JPG count if generated
          jpg_count=$(find src -path "*/jpg/*.jpg" -type f 2>/dev/null | wc -l)
          if [[ $jpg_count -gt 0 ]]; then
            echo ""
            echo "=== JPG Files ==="
            echo "$jpg_count"
          fi

      # ----------------------------------------------------------------
      # Generate summary for PR reviews
      # ----------------------------------------------------------------
      - name: Generate PR summary
        if: github.event_name == 'pull_request'
        run: |
          {
            echo "## ðŸŽ¨ PlantUML Render Results"
            echo ""
            echo "| Metric | Count |"
            echo "|--------|-------|"
            echo "| Source diagrams | ${{ steps.plantuml.outputs.diagram_count }} |"
            echo "| Files rendered | ${{ steps.plantuml.outputs.rendered_count }} |"
            echo "| Failures | ${{ steps.plantuml.outputs.failed_count }} |"
            echo ""
            
            if [[ "${{ steps.plantuml.outputs.failed_count }}" == "0" ]]; then
              echo "âœ… All diagrams rendered successfully!"
            else
              echo "âŒ Some diagrams failed to render. Check the logs above."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Commit job - only runs on push to main (not on PRs)
  # ============================================================================
  commit-images:
    needs: render
    runs-on: ubuntu-latest
    # Only commit on push to main AND when there are changes
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      needs.render.outputs.has-changes == 'true' &&
      github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # Re-render diagrams (checkout is fresh)
      - name: Render PlantUML diagrams
        uses: ./.github/actions/render-plantuml
        with:
          source-dir: 'src'
          formats: 'png svg'
          generate-jpg: ${{ inputs.generate-jpg || 'false' }}
          fail-on-error: 'true'

      # ----------------------------------------------------------------
      # Safe commit with rebase
      # ----------------------------------------------------------------
      - name: Commit rendered images
        run: |
          set -euo pipefail
          
          echo "=== Configuring Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          echo ""
          echo "=== Staging generated artifacts ==="
          
          # Stage only generated image directories
          git add src/**/png/*.png 2>/dev/null || true
          git add src/**/svg/*.svg 2>/dev/null || true
          git add src/**/jpg/*.jpg 2>/dev/null || true
          
          # Check if there are staged changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          echo ""
          echo "=== Staged files ==="
          git diff --cached --name-only | head -50
          
          echo ""
          echo "=== Rebasing before commit ==="
          git fetch origin main
          git rebase origin/main || {
            echo "::warning::Rebase failed, attempting merge instead"
            git rebase --abort 2>/dev/null || true
            git pull --rebase=false origin main
          }
          
          echo ""
          echo "=== Committing ==="
          git commit -m "chore(diagrams): render PlantUML images [skip ci]"
          
          echo ""
          echo "=== Pushing ==="
          git push origin main

      - name: Generate commit summary
        run: |
          {
            echo "## ðŸ“ PlantUML Images Committed"
            echo ""
            echo "| Metric | Count |"
            echo "|--------|-------|"
            echo "| Diagrams processed | ${{ needs.render.outputs.diagram_count }} |"
            echo "| Files rendered | ${{ needs.render.outputs.rendered_count }} |"
            echo ""
            echo "âœ… Rendered images committed to \`main\` branch"
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Manual commit job - for workflow_dispatch with commit-changes=true
  # ============================================================================
  manual-commit:
    needs: render
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      inputs.commit-changes == true &&
      needs.render.outputs.has-changes == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Render PlantUML diagrams
        uses: ./.github/actions/render-plantuml
        with:
          source-dir: 'src'
          formats: 'png svg'
          generate-jpg: ${{ inputs.generate-jpg || 'false' }}
          fail-on-error: 'true'

      - name: Auto-commit rendered images
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(diagrams): render PlantUML images [skip ci]'
          file_pattern: |
            src/**/png/*.png
            src/**/svg/*.svg
            src/**/jpg/*.jpg
