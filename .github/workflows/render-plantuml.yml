name: Render PlantUML diagrams

on:
  workflow_dispatch:
  push:
    paths:
      - "src/**/*.puml"
      - "src/**/plantuml-config.puml"
      - "src/**/config.puml"
      - ".github/workflows/render-plantuml.yml"

permissions:
  contents: write

concurrency:
  group: plantuml-render-${{ github.ref }}
  cancel-in-progress: true

jobs:
  render:
    runs-on: ubuntu-latest

    # Avoid infinite loops when the workflow auto-commits generated images.
    if: github.actor != 'github-actions[bot]'

    env:
      SRC_ROOT: "src"
      # Space-delimited list of config filenames to search for, nearest-first up the directory tree.
      PLANTUML_CONFIG_NAMES: "plantuml-config.puml config.puml"
      # Space-delimited output formats to generate for each diagram.
      PLANTUML_FORMATS: "png svg jpg"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install PlantUML + Graphviz
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y plantuml graphviz

      - name: Render PlantUML diagrams (png/svg/jpg in sibling format folders)
        id: render
        shell: bash
        run: |
          set -euo pipefail

          ROOT_REL="${SRC_ROOT:-src}"
          ROOT_ABS="$(cd "${ROOT_REL}" && pwd)"
          SUMMARY="${GITHUB_WORKSPACE}/plantuml-render-summary.md"

          # Parse env vars (space-delimited).
          read -r -a CONFIG_NAMES <<< "${PLANTUML_CONFIG_NAMES:-plantuml-config.puml config.puml}"
          read -r -a FORMATS <<< "${PLANTUML_FORMATS:-png svg jpg}"

          is_config_file() {
            local b="$1"
            for n in "${CONFIG_NAMES[@]}"; do
              if [[ "$b" == "$n" ]]; then
                return 0
              fi
            done
            return 1
          }

          # Find the nearest config file (if any) by walking upward from a diagram's directory to ROOT_ABS.
          find_nearest_config() {
            local start_dir="$1"
            local d="$start_dir"

            while true; do
              for n in "${CONFIG_NAMES[@]}"; do
                if [[ -f "${d}/${n}" ]]; then
                  realpath "${d}/${n}"
                  return 0
                fi
              done

              [[ "${d}" == "${ROOT_ABS}" ]] && break
              local parent
              parent="$(dirname "${d}")"
              [[ "${parent}" == "${d}" ]] && break
              d="${parent}"
            done

            return 1
          }

          # Discover all .puml under ROOT_ABS.
          mapfile -d '' PUMLS < <(find "${ROOT_ABS}" -type f -name '*.puml' -print0 | sort -z)

          failures=0

          {
            echo "# PlantUML render summary"
            echo
            echo "- Source root: \`${ROOT_REL}\`"
            echo "- Total diagrams discovered: ${#PUMLS[@]}"
            echo "- Output formats: ${FORMATS[*]}"
            echo "- Config filenames searched (nearest-first): ${CONFIG_NAMES[*]}"
            echo
          } > "$SUMMARY"

          for puml_abs in "${PUMLS[@]}"; do
            base="$(basename "$puml_abs")"
            dir_abs="$(dirname "$puml_abs")"
            rel="${puml_abs#${GITHUB_WORKSPACE}/}"

            if is_config_file "$base"; then
              echo "Skipping config: $rel"
              echo "- ⏭️ $rel (config file)" >> "$SUMMARY"
              continue
            fi

            cfg=""
            CFG_ARG=()
            if cfg="$(find_nearest_config "$dir_abs")"; then
              CFG_ARG=(-config "$cfg")
            fi

            # Syntax check first for clearer errors.
            if ! (cd "$dir_abs" && plantuml "${CFG_ARG[@]}" -checkonly "$base" >/dev/null); then
              failures=$((failures+1))
              echo "- ❌ $rel (syntax error)  \`config=${cfg:-none}\`" >> "$SUMMARY"
              echo "Syntax error in: $rel"
              echo "Re-running with -v for details..."
              (cd "$dir_abs" && plantuml "${CFG_ARG[@]}" -v "$base") || true
              continue
            fi

            ok=true
            for fmt in "${FORMATS[@]}"; do
              mkdir -p "${dir_abs}/${fmt}"
              if ! (cd "$dir_abs" && plantuml "${CFG_ARG[@]}" "-t${fmt}" -o "${fmt}" "$base" >/dev/null); then
                ok=false
                echo "  -> ERROR (render ${fmt}): $rel"
              fi
            done

            if [[ "$ok" == "true" ]]; then
              echo "- ✅ $rel  \`config=${cfg:-none}\`" >> "$SUMMARY"
            else
              failures=$((failures+1))
              echo "- ❌ $rel (render failed)  \`config=${cfg:-none}\`" >> "$SUMMARY"
              echo "Re-running with -v for details..."
              (cd "$dir_abs" && plantuml "${CFG_ARG[@]}" -v "$base") || true
            fi
          done

          echo >> "$SUMMARY"
          echo "- Failures: $failures" >> "$SUMMARY"
          echo "failures=$failures" >> "$GITHUB_OUTPUT"

      - name: Commit rendered images
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore(diagrams): render PlantUML images"
          file_pattern: |
            plantuml-render-summary.md
            src/**/png/*.png
            src/**/svg/*.svg
            src/**/jpg/*.jpg

      - name: Fail job if any diagrams failed
        if: ${{ steps.render.outputs.failures != '0' }}
        run: |
          echo "One or more PlantUML diagrams failed to render. See plantuml-render-summary.md."
          exit 1
