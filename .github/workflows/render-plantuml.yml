# .github/workflows/render-plantuml.yml
# Standalone workflow to render PlantUML diagrams and commit back
name: Render PlantUML Diagrams

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      commit-changes:
        description: 'Commit rendered images back to repo'
        type: boolean
        default: true
  push:
    branches: [main]
    paths:
      - 'src/**/*.puml'
      - '!src/**/png/*'
      - '!src/**/svg/*'
      - '.github/workflows/render-plantuml.yml'
      - '.github/actions/render-plantuml/**'

concurrency:
  group: plantuml-${{ github.ref }}
  cancel-in-progress: true

jobs:
  render:
    runs-on: ubuntu-latest
    # Prevent infinite loops from auto-commits
    if: github.actor != 'github-actions[bot]'
    
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Render PlantUML diagrams
        id: render
        uses: ./.github/actions/render-plantuml
        with:
          source-dir: src
          formats: 'png svg'

      - name: Generate render summary
        run: |
          {
            echo "# PlantUML Render Summary"
            echo ""
            echo "- **Run:** ${{ github.run_id }}"
            echo "- **Commit:** \`${{ github.sha }}\`"
            echo "- **Timestamp:** $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo ""
            echo "## Files Processed"
            echo ""
            
            find src -type f -name "*.puml" | sort | while read -r puml; do
              base=$(basename "$puml" .puml)
              if [[ "$base" == "plantuml-config" || "$base" == "config" ]]; then
                echo "- ⭐ \`$puml\` (config file)"
              else
                echo "- ✅ \`$puml\`"
              fi
            done
            
            echo ""
            echo "## Summary"
            echo ""
            rendered=$(find src -type f -name "*.puml" ! -name "*config*.puml" | wc -l)
            skipped=$(find src -type f -name "*config*.puml" | wc -l)
            echo "- Diagrams rendered: **$rendered**"
            echo "- Config files skipped: **$skipped**"
          } > plantuml-render-summary.md

      - name: Auto-commit rendered images
        if: inputs.commit-changes != false
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(diagrams): render PlantUML images [skip ci]'
          file_pattern: |
            plantuml-render-summary.md
            src/**/png/*.png
            src/**/svg/*.svg
