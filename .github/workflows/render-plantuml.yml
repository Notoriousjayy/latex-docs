name: Render PlantUML diagrams

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "src/**/*.puml"
      - ".github/workflows/render-plantuml.yml"

jobs:
  render:
    runs-on: ubuntu-latest

    # Avoid infinite loops when the workflow auto-commits generated images.
    if: github.actor != 'github-actions[bot]'

    permissions:
      contents: write

    env:
      SRC_ROOT: src
      # Config file names to search for (nearest directory wins).
      CONFIG_FILENAMES: "plantuml-config.puml config.puml"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install PlantUML + Graphviz
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends plantuml graphviz
          plantuml -version || true
          dot -V || true

      - name: Render diagrams into per-directory format folders
        id: render
        shell: bash
        run: |
          set -euo pipefail

          WORKSPACE="${GITHUB_WORKSPACE}"
          SRC_ROOT="${SRC_ROOT}"

          summary="plantuml-render-summary.md"
          tmp_summary="$(mktemp)"

          echo "# PlantUML Render Summary" > "$tmp_summary"
          echo "" >> "$tmp_summary"
          echo "- Run: ${GITHUB_RUN_ID}" >> "$tmp_summary"
          echo "- Commit: ${GITHUB_SHA}" >> "$tmp_summary"
          echo "- Timestamp (UTC): $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$tmp_summary"
          echo "" >> "$tmp_summary"

          failures=0
          rendered=0
          skipped=0

          # Find all .puml recursively under SRC_ROOT.
          mapfile -d '' puml_files < <(find "$SRC_ROOT" -type f -name "*.puml" -print0 | sort -z)

          if [[ "${#puml_files[@]}" -eq 0 ]]; then
            echo "No .puml files found under '$SRC_ROOT'."
            echo "failures=0" >> "$GITHUB_OUTPUT"
            cp "$tmp_summary" "$summary"
            exit 0
          fi

          echo "Found ${#puml_files[@]} .puml file(s) under '$SRC_ROOT'."
          echo "" >> "$tmp_summary"
          echo "## Files processed" >> "$tmp_summary"
          echo "" >> "$tmp_summary"

          find_nearest_config() {
            local start_dir="$1"
            local cur="$start_dir"

            # Walk up to the repo root.
            while [[ -n "$cur" && "$cur" != "/" ]]; do
              for cfg_name in ${CONFIG_FILENAMES}; do
                if [[ -f "$cur/$cfg_name" ]]; then
                  (cd "$WORKSPACE" && realpath "$cur/$cfg_name")
                  return 0
                fi
              done

              # Stop if we've reached the repo root.
              if [[ "$cur" == "$WORKSPACE" ]]; then
                break
              fi
              cur="$(dirname "$cur")"
            done

            return 1
          }

          for f in "${puml_files[@]}"; do
            base="$(basename "$f")"

            # Skip config .puml files (they are not diagrams).
            if [[ "$base" == "plantuml-config.puml" || "$base" == "config.puml" ]]; then
              echo "Skipping config: $f"
              echo "- ⏭️  $f (config)" >> "$tmp_summary"
              skipped=$((skipped+1))
              continue
            fi

            dir="$(dirname "$f")"
            abs_dir="$(cd "$WORKSPACE" && realpath "$dir")"
            abs_file="$(cd "$WORKSPACE" && realpath "$f")"

            cfg_path=""
            if cfg_path="$(find_nearest_config "$abs_dir" 2>/dev/null)"; then
              :
            else
              cfg_path=""
            fi

            # Ensure output directories exist next to the diagram file.
            mkdir -p "$dir/png" "$dir/svg" "$dir/jpg"

            echo "Rendering: $f"
            if [[ -n "$cfg_path" ]]; then
              echo "  Using config: ${cfg_path#$WORKSPACE/}"
            else
              echo "  Using config: (none)"
            fi

            # Render from the diagram's directory so -o is relative to it.
            pushd "$dir" >/dev/null

            # Use basename for input to avoid double path confusion after cd.
            in_file="$(basename "$f")"

            # Render formats (continue on error so we can produce a summary and still commit successful renders).
            set +e

            if [[ -n "$cfg_path" ]]; then
              plantuml -v -config "$cfg_path" -tpng -o "png" "$in_file"
              rc_png=$?
              plantuml -v -config "$cfg_path" -tsvg -o "svg" "$in_file"
              rc_svg=$?
              plantuml -v -config "$cfg_path" -tjpg -o "jpg" "$in_file"
              rc_jpg=$?
            else
              plantuml -v -tpng -o "png" "$in_file"
              rc_png=$?
              plantuml -v -tsvg -o "svg" "$in_file"
              rc_svg=$?
              plantuml -v -tjpg -o "jpg" "$in_file"
              rc_jpg=$?
            fi

            set -e
            popd >/dev/null

            if [[ "$rc_png" -ne 0 || "$rc_svg" -ne 0 || "$rc_jpg" -ne 0 ]]; then
              failures=$((failures+1))
              echo "- ❌  $f (png=$rc_png, svg=$rc_svg, jpg=$rc_jpg)" >> "$tmp_summary"
              echo "  ERROR: Render failed for $f (png=$rc_png, svg=$rc_svg, jpg=$rc_jpg)" >&2
            else
              rendered=$((rendered+1))
              echo "- ✅  $f" >> "$tmp_summary"
            fi
          done

          echo "" >> "$tmp_summary"
          echo "## Totals" >> "$tmp_summary"
          echo "" >> "$tmp_summary"
          echo "- Rendered: $rendered" >> "$tmp_summary"
          echo "- Skipped:  $skipped" >> "$tmp_summary"
          echo "- Failed:   $failures" >> "$tmp_summary"

          mv "$tmp_summary" "$summary"
          echo "failures=$failures" >> "$GITHUB_OUTPUT"

      - name: Commit rendered images
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore(diagrams): render PlantUML images"
          # Ensure we commit only the rendered images + summary.
          file_pattern: |
            plantuml-render-summary.md
            src/**/png/*.png
            src/**/svg/*.svg
            src/**/jpg/*.jpg

      - name: Fail workflow if any diagram failed to render
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          failures="${{ steps.render.outputs.failures }}"
          echo "Render failures: $failures"
          if [[ "$failures" -gt 0 ]]; then
            echo "One or more diagrams failed to render. See plantuml-render-summary.md for details." >&2
            exit 1
          fi
