name: Render PlantUML diagrams

on:
  workflow_dispatch:
  push:
    paths:
      - "src/**/*.puml"
      - ".github/workflows/render-plantuml.yml"

permissions:
  contents: write

concurrency:
  group: plantuml-render-${{ github.ref }}
  cancel-in-progress: true

jobs:
  render:
    runs-on: ubuntu-latest

    # Avoid infinite loops when the workflow auto-commits generated images.
    if: github.actor != 'github-actions[bot]'

    env:
      SRC_ROOT: "src"
      # Space-delimited list of config filenames to search for, nearest-first up the directory tree.
      PLANTUML_CONFIG_NAMES: "plantuml-config.puml config.puml"
      # Space-delimited output formats to generate for each diagram.
      PLANTUML_FORMATS: "png svg jpg"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install PlantUML + Graphviz
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y plantuml graphviz

      - name: Render PlantUML diagrams (outputs next to each .puml)
        id: render
        shell: bash
        run: |
          set -euo pipefail

          ROOT="${SRC_ROOT:-src}"
          SUMMARY="${GITHUB_WORKSPACE}/plantuml-render-summary.md"

          # Parse env vars (space-delimited).
          read -r -a CONFIG_NAMES <<< "${PLANTUML_CONFIG_NAMES:-plantuml-config.puml config.puml}"
          read -r -a FORMATS <<< "${PLANTUML_FORMATS:-png svg jpg}"

          # Canonicalize ROOT for safe prefix checks.
          ROOT_ABS="$(cd "$ROOT" && pwd)"

          # Discover PlantUML sources under ROOT.
          mapfile -t PUMLS < <(find "$ROOT" -type f -name '*.puml' | sort)

          if (( ${#PUMLS[@]} == 0 )); then
            echo "No .puml files found under: $ROOT"
            echo "failures=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          failures=0

          {
            echo "# PlantUML render summary"
            echo
            echo "- Source root: \`$ROOT\`"
            echo "- Total diagrams discovered: ${#PUMLS[@]}"
            echo "- Output formats: ${FORMATS[*]}"
            echo "- Config filenames searched (nearest-first): ${CONFIG_NAMES[*]}"
            echo
          } > "$SUMMARY"

          # Find the nearest config file (if any) by walking upward from a diagram's directory to ROOT.
          find_nearest_config() {
            local start_dir="$1"
            local dir="$start_dir"
            while true; do
              for cn in "${CONFIG_NAMES[@]}"; do
                if [[ -f "$dir/$cn" ]]; then
                  echo "$dir/$cn"
                  return 0
                fi
              done

              # Stop if we've reached the root boundary.
              if [[ "$(cd "$dir" && pwd)" == "$ROOT_ABS" ]]; then
                break
              fi

              local parent
              parent="$(dirname "$dir")"
              if [[ "$parent" == "$dir" ]]; then
                break
              fi
              dir="$parent"
            done
            return 1
          }

          # Skip config files themselves (so we don't try to render them).
          is_config_file() {
            local base="$1"
            for cn in "${CONFIG_NAMES[@]}"; do
              if [[ "$base" == "$cn" ]]; then
                return 0
              fi
            done
            return 1
          }

          for puml in "${PUMLS[@]}"; do
            base="$(basename "$puml")"
            if is_config_file "$base"; then
              echo "Skipping config: $puml"
              echo "- ⏭️ $puml (config file)" >> "$SUMMARY"
              continue
            fi

            echo "Processing: $puml"
            dir="$(dirname "$puml")"

            cfg=""
            if cfg="$(find_nearest_config "$dir")"; then
              echo "  -> Using config: $cfg"
              CFG_ARG=(-config "$cfg")
            else
              echo "  -> No config found for this diagram (continuing)."
              CFG_ARG=()
            fi

            # Syntax check first for clearer errors. If it fails, log verbose output and continue.
            if ! plantuml "${CFG_ARG[@]}" -checkonly "$puml" >/dev/null; then
              failures=$((failures+1))
              echo "  -> ERROR (syntax): $puml"
              echo "- ❌ $puml (syntax error)  \`config=${cfg:-none}\`" >> "$SUMMARY"
              echo "  -> Re-running with -v for details..."
              plantuml "${CFG_ARG[@]}" -v "$puml" || true
              continue
            fi

            # Render requested formats next to the .puml file (same directory).
            ok=true
            for fmt in "${FORMATS[@]}"; do
              if ! plantuml "${CFG_ARG[@]}" "-t${fmt}" "$puml" >/dev/null; then
                ok=false
                echo "  -> ERROR (render ${fmt}): $puml"
              fi
            done

            if [[ "$ok" == "true" ]]; then
              echo "  -> OK"
              echo "- ✅ $puml  \`config=${cfg:-none}\`" >> "$SUMMARY"
            else
              failures=$((failures+1))
              echo "- ❌ $puml (render failed)  \`config=${cfg:-none}\`" >> "$SUMMARY"
              echo "  -> Re-running with -v for details..."
              plantuml "${CFG_ARG[@]}" -v "$puml" || true
            fi
          done

          echo >> "$SUMMARY"
          echo "- Failures: $failures" >> "$SUMMARY"
          echo "failures=$failures" >> "$GITHUB_OUTPUT"

      - name: Commit rendered images
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore(diagrams): render PlantUML images"
          file_pattern: "src/**/*.png src/**/*.svg src/**/*.jpg plantuml-render-summary.md"

      - name: Fail job if any diagrams failed
        if: ${{ steps.render.outputs.failures != '0' }}
        run: |
          echo "One or more PlantUML diagrams failed to render. See plantuml-render-summary.md."
          exit 1
