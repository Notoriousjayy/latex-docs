name: Build & Publish LaTeX PDFs to GitHub Pages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "src/**/*.tex"
      - "src/**/*.puml"
      - ".github/workflows/latex-pages.yml"
      - "src/**/png/*.png"
      - "src/**/svg/*.svg"
      - "src/**/jpg/*.jpg"

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    # Use a TeX Live image for reproducible builds.
    # Note: this image may not include apt-get; install tools via the container's package manager.
    container:
      image: ghcr.io/xu-cheng/texlive-full:latest
      options: --user 0

    # Required for committing back to the repo using GITHUB_TOKEN
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
      - name: Install dependencies (bash, GNU coreutils, PlantUML, Graphviz, Java, zip)
        shell: sh
        run: |
          set -eu

          echo "Installing dependencies inside job container..."
          if command -v apk >/dev/null 2>&1; then
            apk update
            # Install GNU userland tools (reliable find/grep/cp) + PlantUML toolchain.
            apk add --no-cache bash coreutils grep findutils zip \
              plantuml graphviz openjdk17-jre-headless
          elif command -v apt-get >/dev/null 2>&1; then
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              bash coreutils findutils grep zip plantuml graphviz default-jre-headless
            rm -rf /var/lib/apt/lists/*
          elif command -v dnf >/dev/null 2>&1; then
            dnf install -y bash coreutils findutils grep zip plantuml graphviz java-17-openjdk-headless
          elif command -v yum >/dev/null 2>&1; then
            yum install -y bash coreutils findutils grep zip plantuml graphviz java-17-openjdk-headless
          else
            echo "ERROR: No supported package manager found in container."
            cat /etc/os-release || true
            exit 1
          fi

          # Create symlink for /usr/bin/bash if bash is at /bin/bash
          if [ -x /bin/bash ] && [ ! -e /usr/bin/bash ]; then
            ln -s /bin/bash /usr/bin/bash
            echo "Created symlink: /usr/bin/bash -> /bin/bash"
          fi

          echo "Installed bash:"
          bash --version | head -n 1
          echo "Installed PlantUML:"
          plantuml -version 2>&1 | head -n 1 || true
          echo "Installed latexmk:"
          latexmk -v 2>&1 | head -n 1 || true
      - name: Render PlantUML diagrams (SVG + PNG)
        shell: bash
        run: |
          set -euo pipefail

          ROOT="src"
          CONFIG_NAMES=("plantuml-config.puml" "config.puml")
          FORMATS=("svg" "png")

          echo "=== Searching for PlantUML files under ${ROOT}/ ==="
          find "$ROOT" -type f -name "*.puml" 2>/dev/null || true
          echo ""

          find_config() {
            local start_dir="$1"
            local d="$start_dir"
            while true; do
              for n in "${CONFIG_NAMES[@]}"; do
                if [[ -f "${d}/${n}" ]]; then
                  echo "${d}/${n}"
                  return 0
                fi
              done
              [[ "$d" == "$ROOT" || "$d" == "." ]] && break
              d="$(dirname "$d")"
            done
            echo ""
          }

          # Collect .puml files (excluding config files)
          PUMLS=()
          while IFS= read -r -d '' file; do
            PUMLS+=("$file")
          done < <(find "$ROOT" -type f -name "*.puml" \
            ! -name "plantuml-config.puml" \
            ! -name "config.puml" \
            -print0 2>/dev/null || true)

          echo "Total diagrams discovered: ${#PUMLS[@]}"

          if [[ ${#PUMLS[@]} -eq 0 ]]; then
            echo "No PlantUML files found under ${ROOT}/"
            exit 0
          fi

          for puml in "${PUMLS[@]}"; do
            dir="$(dirname "$puml")"
            base="$(basename "$puml" .puml)"
            cfg="$(find_config "$dir")"

            mkdir -p "${dir}/svg" "${dir}/png"

            for fmt in "${FORMATS[@]}"; do
              tmp="${dir}/.plantuml-tmp/${base}/${fmt}"
              mkdir -p "$tmp"

              cfg_abs=""
              if [[ -n "$cfg" ]]; then
                cfg_abs="$(readlink -f "$cfg" 2>/dev/null || echo "$cfg")"
              fi

              echo "Rendering: ${puml} -> ${fmt}"
              pushd "$dir" >/dev/null
              if [[ -n "$cfg_abs" ]]; then
                plantuml "-t${fmt}" -o ".plantuml-tmp/${base}/${fmt}" -config "$cfg_abs" "$(basename "$puml")"
              else
                plantuml "-t${fmt}" -o ".plantuml-tmp/${base}/${fmt}" "$(basename "$puml")"
              fi
              popd >/dev/null

              produced="$(find "$tmp" -type f -name "*.${fmt}" 2>/dev/null | head -n 1 || true)"
              if [[ -z "$produced" ]]; then
                echo "ERROR: No ${fmt} produced for ${puml}"
                ls -la "$tmp" 2>/dev/null || true
                exit 1
              fi

              dest="${dir}/${fmt}/${base}.${fmt}"
              mv -f "$produced" "$dest"
              rm -rf "${dir}/.plantuml-tmp/${base}/${fmt}"
              echo "  Created: ${dest}"
            done

            rm -rf "${dir}/.plantuml-tmp/${base}" 2>/dev/null || true
          done

          echo ""
          echo "=== PlantUML rendering complete ==="
          echo "Generated SVG files:"
          find "$ROOT" -path "*/svg/*.svg" -type f 2>/dev/null || echo "(none)"
      - name: Build PDFs (LuaLaTeX)
        shell: bash
        run: |
          set -euo pipefail

          ROOT="src"
          OUT="build/pdfs"
          mkdir -p "$OUT"

          mapfile -d '' TEXFILES < <(find "$ROOT" -type f -name "*.tex" -print0)
          echo "Total TeX files discovered: ${#TEXFILES[@]}"

          if [[ ${#TEXFILES[@]} -eq 0 ]]; then
            echo "No .tex files found under ${ROOT}/"
            exit 0
          fi

          for tex in "${TEXFILES[@]}"; do
            dir="$(dirname "$tex")"
            file="$(basename "$tex")"
            base="${file%.tex}"

            rel="${tex#${ROOT}/}"
            rel_dir="$(dirname "$rel")"
            outdir="${OUT}/${rel_dir}"
            mkdir -p "$outdir"

            echo "=== Building ${tex} ==="
            pushd "$dir" >/dev/null
            latexmk -lualatex -shell-escape -interaction=nonstopmode -halt-on-error -file-line-error "$file"
            popd >/dev/null

            if [[ ! -f "${dir}/${base}.pdf" ]]; then
              echo "ERROR: Expected PDF not found: ${dir}/${base}.pdf"
              exit 1
            fi

            cp -f "${dir}/${base}.pdf" "${outdir}/${base}.pdf"
          done

          echo "=== PDFs written to ${OUT}/ ==="
          find "$OUT" -type f -name "*.pdf" -print

      - name: Update docs/ with latest PDFs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/pdfs
          # Mirror the build/pdfs tree into docs/pdfs (preserve subdirectories)
          rm -rf docs/pdfs/*
          cp -a build/pdfs/. docs/pdfs/

      - name: Commit updated PDFs and index
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(pdfs): refresh rendered PDFs"
          file_pattern: docs/**

  deploy:
    needs: build
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
