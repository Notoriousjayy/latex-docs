# .github/workflows/latex-pages.yml
# Build and publish LaTeX PDFs to GitHub Pages
name: Deploy PDFs to GitHub Pages

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**/*.tex"
      - "src/**/*.puml"
      - "tooling/**"
      - ".github/workflows/*.yml"
      - ".github/actions/**"

concurrency:
  group: pages
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ============================================================================
  # Build all documents (reusable workflow)
  # ============================================================================
  build:
    uses: ./.github/workflows/_build-latex.yml
    with:
      build-all: true
      render-plantuml: true
      upload-artifacts: true

  # ============================================================================
  # Stage PDFs for GitHub Pages
  #   - downloads all "pdfs-*" artifacts (one per category)
  #   - merges into a single "site/pdfs" tree while preserving subdirectories
  #   - (optional) rehydrates structure if any PDFs were flattened upstream
  #   - generates site/index.html from the staged tree
  # ============================================================================
  stage:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all PDF artifacts (pdfs-*)
        uses: actions/download-artifact@v4
        with:
          pattern: "pdfs-*"
          path: all-pdfs
          merge-multiple: false

      - name: Merge all category artifacts (preserve full structure)
        run: |
          set -euo pipefail

          echo "=== Downloaded artifact structure ==="
          # Avoid failing the step due to SIGPIPE when piping into head under pipefail
          set +o pipefail
          find all-pdfs -type d | head -30 || true
          set -o pipefail
          echo ""

          mkdir -p site/pdfs

          # Merge all category artifacts preserving the embedded structure inside each artifact
          for artifact_dir in all-pdfs/pdfs-*/; do
            if [[ -d "${artifact_dir}" ]]; then
              echo "Merging from: ${artifact_dir}"
              # rsync preserves directory structure and does not flatten
              rsync -a "${artifact_dir}/" "site/pdfs/"
            fi
          done

          echo ""
          echo "=== Merged PDF structure (showing directories) ==="
          set +o pipefail
          find site/pdfs -type d | sort | head -60 || true
          set -o pipefail
          echo ""

          total="$(find site/pdfs -name "*.pdf" -type f 2>/dev/null | wc -l | tr -d ' ')"
          echo "Total PDFs: ${total}"

          echo ""
          echo "=== PDF listing (first 60) ==="
          set +o pipefail
          find site/pdfs -name "*.pdf" -type f | sort | head -60 || true
          set -o pipefail

      # Best-effort: if any upstream stage flattened PDFs into a parent directory,
      # restore correct structure by mapping <name>.pdf -> src/**/<name>.tex root that has \documentclass.
      - name: Rehydrate PDF directory structure from src (best-effort)
        run: |
          set -euo pipefail

          moved=0
          skipped=0
          ambiguous=0
          missing=0

          while IFS= read -r -d '' pdf; do
            base="$(basename "$pdf" .pdf)"

            # Find TeX roots by basename; keep only real roots (\documentclass)
            mapfile -d '' tex_matches < <(
              find src -type f -name "${base}.tex" -print0 2>/dev/null | \
              xargs -0 -I{} bash -lc 'grep -qE "^[[:space:]]*\\documentclass" "{}" && printf "%s\0" "{}" || true'
            )

            if [[ ${#tex_matches[@]} -eq 0 ]]; then
              missing=$((missing + 1))
              continue
            fi

            if [[ ${#tex_matches[@]} -gt 1 ]]; then
              echo "::warning::Ambiguous mapping for $(basename "$pdf") (multiple TeX roots). Leaving as-is."
              ambiguous=$((ambiguous + 1))
              continue
            fi

            tex="${tex_matches[0]}"
            rel_tex="${tex#src/}"
            rel_dir="$(dirname "$rel_tex")"
            desired="site/pdfs/${rel_dir}/${base}.pdf"

            # Already correct
            if [[ "$pdf" == "$desired" ]]; then
              skipped=$((skipped + 1))
              continue
            fi

            # Do not clobber
            if [[ -e "$desired" ]]; then
              echo "::warning::Destination exists; skipping move: $desired"
              skipped=$((skipped + 1))
              continue
            fi

            mkdir -p "$(dirname "$desired")"
            mv "$pdf" "$desired"
            moved=$((moved + 1))
          done < <(find site/pdfs -type f -name "*.pdf" -print0 2>/dev/null)

          echo "rehydrate: moved=$moved skipped=$skipped ambiguous=$ambiguous missing=$missing"

      - name: Generate index.html
        run: |
          set -euo pipefail

          cat > site/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>LaTeX PDFs</title>
            <style>
              :root { --bg:#fafafa; --text:#333; --accent:#0066cc; --border:#ddd; --hover:#f0f0f0; }
              @media (prefers-color-scheme: dark) {
                :root { --bg:#1a1a1a; --text:#e0e0e0; --accent:#4da6ff; --border:#444; --hover:#2a2a2a; }
              }
              *{box-sizing:border-box}
              body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;max-width:1000px;margin:0 auto;padding:2rem 1rem;background:var(--bg);color:var(--text);line-height:1.6}
              header{border-bottom:2px solid var(--border);padding-bottom:1rem;margin-bottom:2rem}
              .title{font-size:2rem;margin:0}
              .sub{color:#666;margin:.5rem 0 0 0}
              .sub code{background:var(--hover);padding:.2em .4em;border-radius:3px;font-size:.9em}
              h1{font-size:1.5rem;margin:2rem 0 .5rem 0;padding-top:1rem;border-top:1px solid var(--border)}
              h1:first-of-type{border-top:none;margin-top:0}
              h2{font-size:1.2rem;margin:1.5rem 0 .5rem 0;color:#555}
              h3{font-size:1rem;margin:1rem 0 .3rem 0;color:#666}
              h4{font-size:.95rem;margin:.8rem 0 .3rem 1rem;color:#777}
              h5{font-size:.9rem;margin:.6rem 0 .2rem 1.5rem;color:#888}
              h6{font-size:.85rem;margin:.5rem 0 .2rem 2rem;color:#999}
              ul.files{list-style:none;padding:0;margin:.5rem 0}
              ul.files li{padding:.4rem .6rem;border-radius:4px}
              ul.files li:hover{background:var(--hover)}
              ul.files a{color:var(--accent);text-decoration:none}
              ul.files a:hover{text-decoration:underline}
              .updated{color:#888;font-size:.85rem;margin-top:3rem;padding-top:1rem;border-top:1px solid var(--border)}
              .stats{display:flex;gap:2rem;margin:1rem 0;flex-wrap:wrap}
              .stat{background:var(--hover);padding:1rem;border-radius:8px;min-width:160px}
              .stat-value{font-size:1.5rem;font-weight:700}
              .stat-label{font-size:.85rem;color:#666}
            </style>
          </head>
          <body>
            <header>
              <p class="title">LaTeX PDFs</p>
              <p class="sub">Published from <code>src/**/*.tex</code> roots on the <code>main</code> branch.</p>
            </header>
          HTMLEOF

          total="$(find site/pdfs -name "*.pdf" -type f 2>/dev/null | wc -l | tr -d ' ')"
          categories="$(find site/pdfs -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')"

          cat >> site/index.html << STATSEOF
            <div class="stats">
              <div class="stat">
                <div class="stat-value">${total}</div>
                <div class="stat-label">Documents</div>
              </div>
              <div class="stat">
                <div class="stat-value">${categories}</div>
                <div class="stat-label">Top-level categories</div>
              </div>
            </div>
          STATSEOF

          generate_section() {
            local dir="$1"
            local depth="$2"
            local prefix="$3"

            local total_pdfs
            total_pdfs=$(find "$dir" -name "*.pdf" -type f 2>/dev/null | wc -l | tr -d ' ')
            [[ "$total_pdfs" -eq 0 ]] && return

            local pdfs=()
            while IFS= read -r -d '' f; do pdfs+=("$f"); done < <(
              find "$dir" -maxdepth 1 -name "*.pdf" -type f -print0 2>/dev/null | sort -z
            )

            local subdirs=()
            while IFS= read -r -d '' d; do subdirs+=("$d"); done < <(
              find "$dir" -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null | sort -z
            )

            local htag="h1"
            case $depth in
              1) htag="h1" ;;
              2) htag="h2" ;;
              3) htag="h3" ;;
              4) htag="h4" ;;
              5) htag="h5" ;;
              *) htag="h6" ;;
            esac

            local name id
            name="$(basename "$dir")"
            if [[ -n "$prefix" ]]; then
              id="${prefix}-${name}"
            else
              id="${name}"
            fi

            echo "<${htag} id=\"${id}\">${name}</${htag}>"

            if [[ ${#pdfs[@]} -gt 0 ]]; then
              echo '<ul class="files">'
              for pdf in "${pdfs[@]}"; do
                local fname rel
                fname="$(basename "$pdf")"
                rel="${pdf#site/}"   # => pdfs/...
                echo "<li><a href=\"${rel}\" title=\"${rel}\">${fname}</a></li>"
              done
              echo '</ul>'
            fi

            for subdir in "${subdirs[@]}"; do
              generate_section "$subdir" $((depth + 1)) "$id"
            done
          }

          while IFS= read -r -d '' topdir; do
            generate_section "$topdir" 1 ""
          done < <(find site/pdfs -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null | sort -z) >> site/index.html

          cat >> site/index.html << FOOTEREOF
            <p class="updated">Last updated: $(date -u +'%Y-%m-%d %H:%M UTC')</p>
          </body>
          </html>
          FOOTEREOF

          echo "Generated site/index.html (total PDFs: ${total})"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: stage
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
