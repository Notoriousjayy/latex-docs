name: Build LaTeX PDFs and publish to Pages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "src/**/*.tex"
      - "src/**/png/*.png"
      - "src/**/svg/*.svg"
      - "src/**/jpg/*.jpg"
      - ".github/workflows/latex-pages.yml"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/xu-cheng/texlive-full:latest

    # Avoid infinite loops when the workflow auto-commits generated PDFs / index page.
    if: github.actor != 'github-actions[bot]'

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install Inkscape (for \includesvg)
        shell: bash
        run: |
          set -euo pipefail
          apt-get update -y
          apt-get install -y --no-install-recommends inkscape

      - name: Build all PDFs under src/
        shell: bash
        run: |
          set -euo pipefail
          ROOT="src"
          mapfile -d '' TEX_FILES < <(find "$ROOT" -type f -name "*.tex" -print0)

          if [[ ${#TEX_FILES[@]} -eq 0 ]]; then
            echo "No .tex files found under ${ROOT}/"
            exit 0
          fi

          for tex in "${TEX_FILES[@]}"; do
            dir="$(dirname "$tex")"
            file="$(basename "$tex")"
            echo "Building: ${tex}"

            pushd "$dir" >/dev/null
            latexmk -lualatex -pdf -interaction=nonstopmode -halt-on-error -shell-escape "$file"
            popd >/dev/null
          done

      - name: Copy PDFs into docs/pdfs/ (preserve src/ directory structure)
        shell: bash
        run: |
          set -euo pipefail
          OUT_ROOT="docs/pdfs"
          rm -rf "$OUT_ROOT"
          mkdir -p "$OUT_ROOT"

          while IFS= read -r -d '' pdf; do
            rel="${pdf#src/}"
            out_dir="${OUT_ROOT}/$(dirname "$rel")"
            mkdir -p "$out_dir"
            cp -f "$pdf" "${out_dir}/$(basename "$pdf")"
          done < <(find src -type f -name "*.pdf" -print0)

      - name: Generate docs/index.html (hierarchical directory listing)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import html
          
          root = Path("docs/pdfs")
          out = Path("docs/index.html")
          
          def render_dir(d: Path, depth: int) -> str:
              parts = []
              if depth > 0:
                  level = min(depth, 6)
                  parts.append(f"<h{level}>{html.escape(d.name)}</h{level}>")
          
              pdfs = sorted(d.glob("*.pdf"))
              if pdfs:
                  parts.append("<ul class='files'>")
                  for p in pdfs:
                      href = p.as_posix()
                      parts.append(f"<li><a href='{html.escape(href)}'>{html.escape(p.name)}</a></li>")
                  parts.append("</ul>")
          
              for sub in sorted([p for p in d.iterdir() if p.is_dir()]):
                  parts.append(render_dir(sub, depth + 1))
          
              return "\n".join(parts)
          
          body = render_dir(root, 0) if root.exists() else "<p>No PDFs found.</p>"
          
          out.parent.mkdir(parents=True, exist_ok=True)
          html_content = f'''<!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <title>LaTeX PDFs</title>
            <style>
              body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:1100px;margin:2rem auto;padding:0 1rem;line-height:1.45}}
              header{{margin-bottom:1.5rem}}
              .title{{font-size:1.6rem;font-weight:700;margin:0}}
              .sub{{margin:.25rem 0 0 0;color:#444}}
              ul.files{{margin:.25rem 0 1rem 1.25rem}}
              ul.files li{{margin:.15rem 0}}
              a{{text-decoration:none}}
              a:hover{{text-decoration:underline}}
              h1,h2,h3,h4,h5,h6{{margin:1.2rem 0 .5rem 0}}
            </style>
          </head>
          <body>
            <header>
              <p class="title">LaTeX PDFs</p>
              <p class="sub">Generated from <code>src/</code>; browse by directory.</p>
            </header>
            {body}
          </body>
          </html>
          '''
          out.write_text(html_content, encoding="utf-8")
          PY

      - name: Auto-commit PDFs and Pages index
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore(pdfs): build LaTeX PDFs for Pages"
          file_pattern: |
            docs/index.html
            docs/pdfs/**/*.pdf
