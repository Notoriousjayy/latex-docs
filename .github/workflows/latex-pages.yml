name: Build & Publish LaTeX PDFs to GitHub Pages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "src/**/*.tex"
      - ".github/workflows/latex-pages.yml"
      - "src/**/png/*.png"
      - "src/**/svg/*.svg"
      - "src/**/jpg/*.jpg"

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    # Use a TeX Live image for reproducible builds.
    # Note: this image may not include apt-get; install tools via the container's package manager.
    container:
      image: ghcr.io/xu-cheng/texlive-full:latest
      options: --user 0

    # Required for committing back to the repo using GITHUB_TOKEN
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install dependencies (bash, Inkscape)
        shell: sh
        run: |
          set -eu

          echo "Installing dependencies inside job container..."
          if command -v apk >/dev/null 2>&1; then
            apk update
            apk add --no-cache bash inkscape
          elif command -v apt-get >/dev/null 2>&1; then
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends bash inkscape
            rm -rf /var/lib/apt/lists/*
          elif command -v dnf >/dev/null 2>&1; then
            dnf install -y bash inkscape
          elif command -v yum >/dev/null 2>&1; then
            yum install -y bash inkscape
          else
            echo "ERROR: No supported package manager found in container."
            cat /etc/os-release || true
            exit 1
          fi

          # Create symlink for /usr/bin/bash if bash is at /bin/bash
          if [ -x /bin/bash ] && [ ! -e /usr/bin/bash ]; then
            ln -s /bin/bash /usr/bin/bash
            echo "Created symlink: /usr/bin/bash -> /bin/bash"
          fi

          echo "Installed bash:"
          bash --version | head -n 1
          echo "Installed Inkscape:"
          inkscape -V || true

      - name: Build PDFs (via Makefile)
        shell: bash
        run: |
          set -euo pipefail
          make render-pdfs

      - name: Update docs/ with latest PDFs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/pdfs
          # Copy build outputs into docs/ for GitHub Pages publishing
          cp -v build/pdfs/*.pdf docs/pdfs/ || true

      - name: Commit updated PDFs and index
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(pdfs): refresh rendered PDFs"
          file_pattern: docs/**

  deploy:
    needs: build
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4