name: LaTeX Pages (Publish PDFs)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install TeX toolchain
        shell: bash
        run: |
          set -euo pipefail

          # Workaround: disable Microsoft/Azure apt repos that can 403 on hosted runners
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list /etc/apt/sources.list.d/microsoft-prod.list || true

          sudo apt-get update
          sudo apt-get install -y \
            latexmk \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-pictures \
            texlive-science \
            texlive-bibtex-extra \
            biber \
            python3-pygments

          # Fail fast if common dependencies are missing
          kpsewhich inconsolata.sty >/dev/null
          kpsewhich siunitx.sty >/dev/null

      - name: Build all documents (src LaTeX roots)
        run: make build-all

      - name: Stage site (PDF library + index)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf site
          mkdir -p site/pdfs

          # Function to extract and clean title from a .tex file
          extract_title() {
            local tex_file="$1"
            local title=""

            # Extract title - handle multi-line titles (title may span lines after \title{)
            # First try to get a simple single-line title
            title=$(grep -oP '\\title\{[^}]*\}' "$tex_file" 2>/dev/null | head -1 | sed 's/\\title{//;s/}$//' || true)

            # If empty or just whitespace, try multi-line extraction
            if [[ -z "${title// /}" ]]; then
              title=$(sed -n '/\\title{/,/}/{ s/.*\\title{//; s/}.*//; p; }' "$tex_file" 2>/dev/null | tr '\n' ' ' | head -c 500 || true)
            fi

            # Clean up LaTeX formatting
            title=$(echo "$title" \
              | sed 's/\\textbf{//g' \
              | sed 's/\\textit{//g' \
              | sed 's/\\emph{//g' \
              | sed 's/\\large//g' \
              | sed 's/\\Large//g' \
              | sed 's/\\LARGE//g' \
              | sed 's/\\huge//g' \
              | sed 's/\\Huge//g' \
              | sed 's/\\normalsize//g' \
              | sed 's/\\\\//g' \
              | sed 's/\[[^]]*\]//g' \
              | sed 's/{//g' \
              | sed 's/}//g' \
              | sed 's/%//g' \
              | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
              | sed 's/[[:space:]]\+/ /g' \
              | tr -d '\n' \
              | head -c 200)

            echo "$title"
          }

          # Copy PDFs and build title mapping
          declare -A pdf_titles

          while IFS= read -r -d '' pdf; do
            rel="${pdf#src/}"
            out="site/pdfs/${rel}"
            mkdir -p "$(dirname "$out")"
            cp -v "$pdf" "$out"

            # Find corresponding .tex file
            tex_file="${pdf%.pdf}.tex"
            if [[ -f "$tex_file" ]]; then
              title=$(extract_title "$tex_file")
              if [[ -n "$title" && "$title" != " " ]]; then
                pdf_titles["$rel"]="$title"
              fi
            fi
          done < <(find src -type f -name '*.pdf' -print0)

          count="$(find site/pdfs -type f -name '*.pdf' | wc -l | tr -d ' ')"
          echo "Staged PDFs: $count"
          test "$count" -gt 0

          # Generate index.html with document titles as link text
          {
            echo '<!doctype html>'
            echo '<html><head><meta charset="utf-8">'
            echo '<meta name="viewport" content="width=device-width,initial-scale=1">'
            echo '<title>LaTeX PDFs</title>'
            echo '<style>'
            echo 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:960px;margin:2rem auto;padding:0 1rem;line-height:1.6}'
            echo 'code{background:#f3f4f6;padding:.1rem .3rem;border-radius:.25rem;font-size:0.9em}'
            echo 'ul{list-style:none;padding:0}'
            echo 'li{margin:0.5rem 0;padding:0.5rem;border-radius:0.25rem;transition:background 0.2s}'
            echo 'li:hover{background:#f3f4f6}'
            echo 'a{color:#2563eb;text-decoration:none}'
            echo 'a:hover{text-decoration:underline}'
            echo '.path{color:#6b7280;font-size:0.85em;display:block;margin-top:0.25rem}'
            echo '</style>'
            echo '</head><body>'
            echo '<h1>LaTeX PDFs</h1>'
            echo '<p>Published from <code>src/**/*.tex</code> roots on the <code>main</code> branch.</p>'
            echo '<ul>'

            find site/pdfs -type f -name '*.pdf' | sort | sed 's|^site/||' | while read -r p; do
              rel_path="${p#pdfs/}"
              tex_file="src/${rel_path%.pdf}.tex"

              # Extract title from .tex file
              if [[ -f "$tex_file" ]]; then
                label=$(extract_title "$tex_file")
              else
                label=""
              fi

              # Fallback to filename if no title found
              if [[ -z "${label// /}" ]]; then
                label=$(basename "$rel_path" .pdf | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
              fi

              # Escape HTML entities in label
              label=$(echo "$label" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')

              echo "<li><a href=\"${p}\">${label}</a><span class=\"path\"><code>${rel_path}</code></span></li>"
            done

            echo '</ul>'
            echo '</body></html>'
          } > site/index.html

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - id: deployment
        uses: actions/deploy-pages@v4