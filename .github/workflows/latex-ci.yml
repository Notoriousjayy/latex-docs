name: LaTeX CI (build check)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "src/**/*.tex"
      - ".github/workflows/latex-ci.yml"
      - "src/**/png/*.png"
      - "src/**/svg/*.svg"
      - "src/**/jpg/*.jpg"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/xu-cheng/texlive-full:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Inkscape (for \includesvg)
        shell: bash
        run: |
          set -euo pipefail
          apt-get update -y
          apt-get install -y --no-install-recommends inkscape

      - name: Build all PDFs under src/
        shell: bash
        run: |
          set -euo pipefail

          ROOT="src"
          mapfile -d '' TEX_FILES < <(find "$ROOT" -type f -name "*.tex" -print0)

          if [[ ${#TEX_FILES[@]} -eq 0 ]]; then
            echo "No .tex files found under ${ROOT}/"
            exit 0
          fi

          for tex in "${TEX_FILES[@]}"; do
            dir="$(dirname "$tex")"
            file="$(basename "$tex")"
            echo "Building: ${tex}"

            pushd "$dir" >/dev/null
            latexmk -lualatex -pdf -interaction=nonstopmode -halt-on-error -shell-escape "$file"
            popd >/dev/null
          done

      - name: Upload PDFs as build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: latex-pdfs
          path: |
            src/**/*.pdf
