# .github/workflows/latex-release.yml
# Build and attach PDFs to GitHub releases
name: LaTeX Release

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  # ============================================================================
  # Build all documents for release
  # ============================================================================
  build:
    uses: ./.github/workflows/_build-latex.yml
    with:
      build-all: true  # Releases need complete builds
      render-plantuml: true
      upload-artifacts: true

  # ============================================================================
  # Package and attach to release
  # ============================================================================
  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download built PDFs
        uses: actions/download-artifact@v4
        with:
          name: latex-pdfs
          path: pdfs

      - name: Create release archive
        run: |
          mkdir -p dist
          
          # Create a single zip with all PDFs
          cd pdfs
          zip -r ../dist/latex-pdfs.zip . -i '*.pdf'
          cd ..
          
          # Also create category-specific zips for selective downloads
          for category in $(find pdfs -mindepth 1 -maxdepth 1 -type d -exec basename {} \;); do
            if find "pdfs/$category" -name "*.pdf" -type f | head -1 | grep -q .; then
              cd pdfs
              zip -r "../dist/${category}-pdfs.zip" "$category" -i '*.pdf'
              cd ..
            fi
          done
          
          echo "Release archives created:"
          ls -lh dist/

      - name: Attach to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
