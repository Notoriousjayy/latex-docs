name: LaTeX Release

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/xu-cheng/texlive-full:latest
      options: --user 0

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Inkscape + zip (required for SVG conversion and packaging)
        shell: bash
        run: |
          set -euo pipefail

          install_pkgs_apk() {
            apk update
            apk add --no-cache inkscape zip
          }

          install_pkgs_apt() {
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends inkscape zip
            rm -rf /var/lib/apt/lists/*
          }

          if command -v inkscape >/dev/null 2>&1 && command -v zip >/dev/null 2>&1; then
            echo "Inkscape already installed:"
            inkscape -V || true
            echo "zip already installed:"
            zip -v | head -n 2 || true
            exit 0
          fi

          echo "Installing tooling inside job container..."
          if command -v apk >/dev/null 2>&1; then
            install_pkgs_apk
          elif command -v apt-get >/dev/null 2>&1; then
            install_pkgs_apt
          elif command -v dnf >/dev/null 2>&1; then
            dnf install -y inkscape zip
          elif command -v yum >/dev/null 2>&1; then
            yum install -y inkscape zip
          else
            echo "ERROR: No supported package manager found in container."
            cat /etc/os-release || true
            exit 1
          fi

          echo "Installed Inkscape:"
          inkscape -V
          echo "Installed zip:"
          zip -v | head -n 2 || true

      - name: Build PDFs (via Makefile)
        shell: bash
        run: |
          set -euo pipefail
          make render-pdfs

      - name: Package PDFs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          zip -r dist/pdfs.zip build/pdfs

      - name: Upload Release Asset (pdfs.zip)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/pdfs.zip
