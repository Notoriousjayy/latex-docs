name: Release LaTeX PDFs (build artifacts)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/xu-cheng/texlive-full:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Inkscape (for \includesvg)
        shell: bash
        run: |
          set -euo pipefail
          apt-get update -y
          apt-get install -y --no-install-recommends inkscape zip

      - name: Build all PDFs under src/
        shell: bash
        run: |
          set -euo pipefail
          ROOT="src"
          mapfile -d '' TEX_FILES < <(find "$ROOT" -type f -name "*.tex" -print0)

          if [[ ${#TEX_FILES[@]} -eq 0 ]]; then
            echo "No .tex files found under ${ROOT}/"
            exit 0
          fi

          for tex in "${TEX_FILES[@]}"; do
            dir="$(dirname "$tex")"
            file="$(basename "$tex")"
            echo "Building: ${tex}"

            pushd "$dir" >/dev/null
            latexmk -lualatex -pdf -interaction=nonstopmode -halt-on-error -shell-escape "$file"
            popd >/dev/null
          done

      - name: Package PDFs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          while IFS= read -r -d '' pdf; do
            rel="${pdf#src/}"
            out_dir="dist/$(dirname "$rel")"
            mkdir -p "$out_dir"
            cp -f "$pdf" "$out_dir/"
          done < <(find src -type f -name "*.pdf" -print0)

          (cd dist && zip -r ../latex-pdfs.zip .)

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: latex-pdfs-zip
          path: latex-pdfs.zip
