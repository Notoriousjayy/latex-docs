# .github/workflows/_build-latex.yml
# Reusable workflow for building LaTeX documents
# Renders PlantUML diagrams inline before compilation (no external dependencies)
name: _Build LaTeX (Reusable)

on:
  workflow_call:
    inputs:
      build-all:
        description: 'Build all documents (ignore change detection)'
        type: boolean
        default: false
      document-category:
        description: 'Category filter (architecture, devops, security, etc.) or empty for all'
        type: string
        default: ''
      upload-artifacts:
        description: 'Upload built PDFs as artifacts'
        type: boolean
        default: true
    outputs:
      pdf-count:
        description: 'Total PDFs built'
        value: ${{ jobs.aggregate.outputs.total }}
      artifact-name:
        description: 'Name of uploaded artifact'
        value: 'latex-pdfs'

jobs:
  # ============================================================================
  # Stage 1: Determine what changed and prepare build matrix
  # ============================================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: changes
        run: |
          set -euo pipefail

          if [[ "${{ inputs.build-all }}" == "true" ]]; then
            echo "Build-all requested"
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger - building everything"
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "")
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          echo "Changed files:"
          echo "$CHANGED"

          TEX_CHANGES=$(echo "$CHANGED" | grep -E '\.tex$' || echo "")
          PUML_CHANGES=$(echo "$CHANGED" | grep -E '\.puml$' || echo "")
          WORKFLOW_CHANGES=$(echo "$CHANGED" | grep -E '\.github/' || echo "")
          TOOLING_CHANGES=$(echo "$CHANGED" | grep -E '^tooling/' || echo "")

          if [[ -n "$TEX_CHANGES" || -n "$PUML_CHANGES" || -n "$WORKFLOW_CHANGES" || -n "$TOOLING_CHANGES" || -z "$CHANGED" ]]; then
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build matrix of document categories
        id: matrix
        run: |
          set -euo pipefail

          CATEGORY="${{ inputs.document-category }}"
          EXCLUDE_DIRS="common|jpg|png|svg|puml"

          if [[ -n "$CATEGORY" ]]; then
            echo "matrix={\"category\":[\"$CATEGORY\"]}" >> "$GITHUB_OUTPUT"
          else
            CATEGORIES=()
            for dir in src/*/; do
              dirname=$(basename "$dir")
              if echo "$dirname" | grep -qE "^($EXCLUDE_DIRS)$"; then
                continue
              fi
              if find "$dir" -name '*.tex' -type f -exec grep -l '^\s*\\documentclass' {} \; -quit 2>/dev/null | grep -q .; then
                CATEGORIES+=("$dirname")
                echo "Found document category: $dirname"
              fi
            done

            if [[ ${#CATEGORIES[@]} -eq 0 ]]; then
              echo "::error::No document categories found in src/"
              exit 1
            fi

            MATRIX_JSON=$(printf '%s\n' "${CATEGORIES[@]}" | jq -R . | jq -sc .)
            echo "matrix={\"category\":$MATRIX_JSON}" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================================
  # Stage 2: Build documents (with inline PlantUML rendering)
  # ============================================================================
  build:
    needs: prepare
    if: needs.prepare.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # PlantUML Rendering (inline, no external action dependency)
      # ----------------------------------------------------------------------
      - name: Install PlantUML
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends plantuml graphviz default-jre-headless

      - name: Render PlantUML diagrams for ${{ matrix.category }}
        run: |
          set -euo pipefail
          
          CATEGORY_DIR="src/${{ matrix.category }}"
          CONFIG_NAMES=("plantuml-config.puml" "config.puml")
          FORMATS=(png svg)
          
          echo "=== Rendering PlantUML diagrams in $CATEGORY_DIR ==="
          
          # Function to find nearest config file
          find_config() {
            local start_dir="$1"
            local d="$start_dir"
            while true; do
              for n in "${CONFIG_NAMES[@]}"; do
                if [[ -f "${d}/${n}" ]]; then
                  readlink -f "${d}/${n}"
                  return 0
                fi
              done
              [[ "$d" == "src" || "$d" == "." ]] && break
              d="$(dirname "$d")"
            done
            echo ""
          }
          
          # Find all .puml files (excluding configs)
          mapfile -d '' PUMLS < <(
            find "$CATEGORY_DIR" -type f -name "*.puml" \
              ! -name "plantuml-config.puml" \
              ! -name "config.puml" \
              -print0 2>/dev/null || true
          )
          
          if [[ ${#PUMLS[@]} -eq 0 ]]; then
            echo "No PlantUML diagrams found in $CATEGORY_DIR"
            exit 0
          fi
          
          echo "Found ${#PUMLS[@]} PlantUML diagrams"
          
          rendered=0
          failed=0
          
          for puml in "${PUMLS[@]}"; do
            [[ -z "$puml" ]] && continue
            
            dir="$(dirname "$puml")"
            base="$(basename "$puml" .puml)"
            cfg="$(find_config "$dir")"
            
            echo ""
            echo "Rendering: $puml"
            
            for fmt in "${FORMATS[@]}"; do
              mkdir -p "${dir}/${fmt}"
              dest="${dir}/${fmt}/${base}.${fmt}"
              
              pushd "$dir" >/dev/null
              if [[ -n "$cfg" ]]; then
                plantuml "-t${fmt}" -o "${fmt}" -config "$cfg" "$(basename "$puml")" 2>&1 || true
              else
                plantuml "-t${fmt}" -o "${fmt}" "$(basename "$puml")" 2>&1 || true
              fi
              popd >/dev/null
              
              if [[ -f "$dest" ]]; then
                echo "  ✓ ${fmt}/${base}.${fmt}"
                ((rendered++))
              else
                echo "  ✗ Failed: ${fmt}/${base}.${fmt}"
                ((failed++))
              fi
            done
          done
          
          echo ""
          echo "=== PlantUML Summary ==="
          echo "Rendered: $rendered files"
          echo "Failed: $failed files"

      - name: Verify PlantUML outputs
        run: |
          echo "=== Verifying PlantUML outputs for ${{ matrix.category }} ==="
          CATEGORY_DIR="src/${{ matrix.category }}"
          
          echo ""
          echo "SVG files:"
          find "$CATEGORY_DIR" -type f -name "*.svg" -path "*/svg/*" 2>/dev/null | head -20 || echo "  (none)"
          
          echo ""
          echo "PNG files:"
          find "$CATEGORY_DIR" -type f -name "*.png" -path "*/png/*" 2>/dev/null | head -20 || echo "  (none)"
          
          # Specific check for pipe-and-filter if in architecture category
          if [[ "${{ matrix.category }}" == "architecture" ]]; then
            echo ""
            echo "Checking pipe-and-filter directory:"
            pf_dir="src/architecture/views-and-beyond/component-connector-viewtype/pipe-and-filter"
            if [[ -d "$pf_dir/svg" ]]; then
              ls -la "$pf_dir/svg/" | head -15
            else
              echo "  WARNING: $pf_dir/svg/ does not exist"
            fi
          fi

      # ----------------------------------------------------------------------
      # LaTeX Setup and Compilation
      # ----------------------------------------------------------------------
      - name: Setup LaTeX
        uses: ./.github/actions/setup-latex

      - name: Build ${{ matrix.category }} documents
        id: build
        uses: ./.github/actions/build-documents
        with:
          source-dir: src
          document-filter: 'src/${{ matrix.category }}'
          build-all: ${{ inputs.build-all }}
          cache-aux-files: 'true'

      - name: Collect PDFs for upload
        id: collect
        run: |
          set -euo pipefail
          
          CATEGORY="${{ matrix.category }}"
          echo "Collecting PDFs for category: $CATEGORY"
          
          mkdir -p "collected-pdfs/${CATEGORY}"
          
          # Find all PDFs and preserve directory structure
          while IFS= read -r -d '' pdf; do
            # Get relative path from src/
            rel_path="${pdf#src/}"
            dest_dir="collected-pdfs/$(dirname "$rel_path")"
            mkdir -p "$dest_dir"
            cp "$pdf" "$dest_dir/"
            echo "Collected: $rel_path"
          done < <(find "src/${CATEGORY}" -name "*.pdf" -type f -print0 2>/dev/null)
          
          # Also collect build logs
          while IFS= read -r -d '' log; do
            rel_path="${log#src/}"
            dest_dir="collected-pdfs/$(dirname "$rel_path")"
            mkdir -p "$dest_dir"
            cp "$log" "$dest_dir/"
          done < <(find "src/${CATEGORY}" \( -name "*.log.txt" -o -name "*.build.stdout.txt" -o -name "*.build.stderr.txt" \) -type f -print0 2>/dev/null)
          
          count=$(find "collected-pdfs" -name "*.pdf" -type f 2>/dev/null | wc -l)
          echo "count=$count" >> "$GITHUB_OUTPUT"
          echo "Collected $count PDFs"

      - name: Upload category PDFs
        uses: actions/upload-artifact@v4
        with:
          name: pdfs-${{ matrix.category }}
          path: collected-pdfs
          retention-days: 7
          if-no-files-found: warn

  # ============================================================================
  # Stage 3: Aggregate all PDFs into single artifact
  # ============================================================================
  aggregate:
    needs: build
    if: always() && needs.build.result != 'cancelled'
    runs-on: ubuntu-latest
    outputs:
      total: ${{ steps.count.outputs.total }}
    steps:
      - name: Download all PDF artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pdfs-*
          path: all-pdfs
          merge-multiple: false

      - name: Merge PDFs
        id: count
        run: |
          set -euo pipefail
          
          echo "=== Downloaded artifacts ==="
          find all-pdfs -type d | head -30 || true
          
          mkdir -p merged-pdfs
          
          for artifact_dir in all-pdfs/pdfs-*/; do
            if [[ -d "$artifact_dir" ]]; then
              echo "Merging from: $artifact_dir"
              cp -r "$artifact_dir"/* merged-pdfs/ 2>/dev/null || true
            fi
          done
          
          echo ""
          echo "=== Merged structure ==="
          find merged-pdfs -type d | sort | head -50 || true
          
          total=$(find merged-pdfs -name "*.pdf" -type f 2>/dev/null | wc -l || echo 0)
          echo "total=$total" >> "$GITHUB_OUTPUT"
          echo ""
          echo "Total PDFs: $total"
          
          echo ""
          echo "=== All PDFs ==="
          find merged-pdfs -name "*.pdf" -type f | sort | head -100

      - name: Upload merged artifact
        if: inputs.upload-artifacts == true
        uses: actions/upload-artifact@v4
        with:
          name: latex-pdfs
          path: merged-pdfs
          retention-days: 30
          if-no-files-found: warn

      - name: Generate build summary
        run: |
          {
            echo "## LaTeX Build Summary"
            echo ""
            echo "**Total PDFs:** ${{ steps.count.outputs.total }}"
            echo ""
            echo "### By Category"
            echo ""
            for artifact_dir in all-pdfs/pdfs-*/; do
              if [[ -d "$artifact_dir" ]]; then
                category=$(basename "$artifact_dir" | sed 's/pdfs-//')
                count=$(find "$artifact_dir" -name "*.pdf" -type f 2>/dev/null | wc -l || echo 0)
                echo "- **$category**: $count PDFs"
              fi
            done
          } >> "$GITHUB_STEP_SUMMARY"