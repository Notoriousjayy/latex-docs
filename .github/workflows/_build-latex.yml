# .github/workflows/_build-latex.yml
# ============================================================================
# REUSABLE WORKFLOW FOR BUILDING LATEX DOCUMENTS
# ============================================================================
# Now uses the unified render-plantuml action (DRY - no inline duplication)
# ============================================================================
name: _Build LaTeX (Reusable)

on:
  workflow_call:
    inputs:
      build-all:
        description: 'Build all documents (ignore change detection)'
        type: boolean
        default: false
      document-category:
        description: 'Category filter (architecture, devops, security, etc.) or empty for all'
        type: string
        default: ''
      upload-artifacts:
        description: 'Upload built PDFs as artifacts'
        type: boolean
        default: true
      render-plantuml:
        description: 'Render PlantUML diagrams before LaTeX compilation'
        type: boolean
        default: true
      generate-jpg:
        description: 'Generate JPG files from PNG (passed to PlantUML action)'
        type: boolean
        default: false
    outputs:
      pdf-count:
        description: 'Total PDFs built'
        value: ${{ jobs.aggregate.outputs.total }}
      artifact-name:
        description: 'Name of uploaded artifact'
        value: 'latex-pdfs'

jobs:
  # ============================================================================
  # Stage 1: Determine what changed and prepare build matrix
  # ============================================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: changes
        run: |
          set -euo pipefail

          if [[ "${{ inputs.build-all }}" == "true" ]]; then
            echo "Build-all requested"
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger - building everything"
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "")
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          echo "Changed files:"
          echo "$CHANGED"

          TEX_CHANGES=$(echo "$CHANGED" | grep -E '\.tex$' || echo "")
          PUML_CHANGES=$(echo "$CHANGED" | grep -E '\.puml$' || echo "")
          WORKFLOW_CHANGES=$(echo "$CHANGED" | grep -E '\.github/' || echo "")
          TOOLING_CHANGES=$(echo "$CHANGED" | grep -E '^tooling/' || echo "")

          if [[ -n "$TEX_CHANGES" || -n "$PUML_CHANGES" || -n "$WORKFLOW_CHANGES" || -n "$TOOLING_CHANGES" || -z "$CHANGED" ]]; then
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build matrix of document categories
        id: matrix
        run: |
          set -euo pipefail

          CATEGORY="${{ inputs.document-category }}"
          EXCLUDE_DIRS="common|jpg|png|svg|puml"

          if [[ -n "$CATEGORY" ]]; then
            echo "matrix={\"category\":[\"$CATEGORY\"]}" >> "$GITHUB_OUTPUT"
          else
            CATEGORIES=()
            for dir in src/*/; do
              dirname=$(basename "$dir")
              if echo "$dirname" | grep -qE "^($EXCLUDE_DIRS)$"; then
                continue
              fi
              if find "$dir" -name '*.tex' -type f -exec grep -l '^\s*\\documentclass' {} \; -quit 2>/dev/null | grep -q .; then
                CATEGORIES+=("$dirname")
                echo "Found document category: $dirname"
              fi
            done

            if [[ ${#CATEGORIES[@]} -eq 0 ]]; then
              echo "::error::No document categories found in src/"
              exit 1
            fi

            MATRIX_JSON=$(printf '%s\n' "${CATEGORIES[@]}" | jq -R . | jq -sc .)
            echo "matrix={\"category\":$MATRIX_JSON}" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================================
  # Stage 2: Build documents (using unified PlantUML action)
  # ============================================================================
  build:
    needs: prepare
    if: needs.prepare.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # PlantUML Rendering - Uses the SINGLE render unit (DRY)
      # ----------------------------------------------------------------------
      - name: Render PlantUML diagrams for ${{ matrix.category }}
        if: inputs.render-plantuml
        id: plantuml
        uses: ./.github/actions/render-plantuml
        with:
          source-dir: 'src/${{ matrix.category }}'
          formats: 'png svg'
          generate-jpg: ${{ inputs.generate-jpg && 'true' || 'false' }}
          fail-on-error: 'false'  # Don't fail build on diagram issues

      - name: Verify PlantUML outputs
        if: inputs.render-plantuml
        run: |
          echo "=== PlantUML Render Results for ${{ matrix.category }} ==="
          echo "Diagrams found: ${{ steps.plantuml.outputs.diagram_count || 0 }}"
          echo "Files rendered: ${{ steps.plantuml.outputs.rendered_count || 0 }}"
          echo "Failures: ${{ steps.plantuml.outputs.failed_count || 0 }}"
          echo ""
          
          CATEGORY_DIR="src/${{ matrix.category }}"
          
          echo "SVG files:"
          find "$CATEGORY_DIR" -type f -name "*.svg" -path "*/svg/*" 2>/dev/null | head -20 || echo "  (none)"
          
          echo ""
          echo "PNG files:"
          find "$CATEGORY_DIR" -type f -name "*.png" -path "*/png/*" 2>/dev/null | head -20 || echo "  (none)"
          
          # Specific check for pipe-and-filter if in architecture category
          if [[ "${{ matrix.category }}" == "architecture" ]]; then
            echo ""
            echo "Checking pipe-and-filter directory:"
            pf_dir="src/architecture/views-and-beyond/component-connector-viewtype/pipe-and-filter"
            if [[ -d "$pf_dir/svg" ]]; then
              ls -la "$pf_dir/svg/" | head -15
            else
              echo "  WARNING: $pf_dir/svg/ does not exist"
            fi
          fi

      # ----------------------------------------------------------------------
      # LaTeX Setup and Compilation
      # ----------------------------------------------------------------------
      - name: Setup LaTeX
        uses: ./.github/actions/setup-latex

      - name: Build ${{ matrix.category }} LaTeX roots (recursive) and stage outputs
        id: build
        shell: bash
        run: |
          set -euo pipefail

          CATEGORY="${{ matrix.category }}"
          CATEGORY_DIR="src/${CATEGORY}"

          echo "=== Building LaTeX roots under ${CATEGORY_DIR} (recursive) ==="

          mkdir -p collected-pdfs build-out build-logs

          # Discover standalone LaTeX roots within the category (no depth limit)
          mapfile -d '' roots < <(grep -RIlZ --include='*.tex' '^[[:space:]]*\\documentclass' "${CATEGORY_DIR}" 2>/dev/null | sort -z || true)

          if [[ ${#roots[@]} -eq 0 ]]; then
            echo "No LaTeX roots found under ${CATEGORY_DIR}"
            echo "count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found ${#roots[@]} LaTeX roots"

          built=0
          failed=0
          failed_list=()

          detect_engine() {
            local f="$1"
            if grep -qiE '^[[:space:]]*%[[:space:]]*!TeX[[:space:]]+program[[:space:]]*=[[:space:]]*lualatex' "$f"; then
              echo "lualatex"
            elif grep -qiE '^[[:space:]]*%[[:space:]]*!TeX[[:space:]]+program[[:space:]]*=[[:space:]]*xelatex' "$f"; then
              echo "xelatex"
            else
              echo "pdflatex"
            fi
          }

          common_args='-interaction=nonstopmode -halt-on-error -file-line-error -shell-escape'

          for tex in "${roots[@]}"; do
            [[ -z "$tex" ]] && continue

            rel="${tex#src/}"
            rel_dir="$(dirname "$rel")"
            base="$(basename "$rel" .tex)"

            out_dir="$GITHUB_WORKSPACE/build-out/${rel_dir}/${base}"
            log_dir="$GITHUB_WORKSPACE/build-logs/${rel_dir}"
            dest_dir="$GITHUB_WORKSPACE/collected-pdfs/${rel_dir}"

            mkdir -p "$out_dir" "$log_dir" "$dest_dir"

            engine="$(detect_engine "$tex")"

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Building: ${tex} (engine=${engine})"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            stdout_log="${log_dir}/${base}.build.stdout.txt"
            stderr_log="${log_dir}/${base}.build.stderr.txt"

            doc_dir="$(dirname "$tex")"
            tex_file="$(basename "$tex")"

            pushd "$doc_dir" >/dev/null

            if [[ "$engine" == "lualatex" ]]; then
              latexmk -pdf \
                -outdir="$out_dir" \
                -pdflatex="lualatex ${common_args} %O %S" \
                "$tex_file" \
                >"$stdout_log" 2>"$stderr_log" || true
            elif [[ "$engine" == "xelatex" ]]; then
              latexmk -pdf \
                -outdir="$out_dir" \
                -pdflatex="xelatex ${common_args} %O %S" \
                "$tex_file" \
                >"$stdout_log" 2>"$stderr_log" || true
            else
              latexmk -pdf \
                -outdir="$out_dir" \
                -pdflatex="pdflatex ${common_args} %O %S" \
                "$tex_file" \
                >"$stdout_log" 2>"$stderr_log" || true
            fi

            popd >/dev/null

            built_pdf="${out_dir}/${base}.pdf"
            dest_pdf="${dest_dir}/${base}.pdf"

            if [[ -f "$built_pdf" ]]; then
              cp -f "$built_pdf" "$dest_pdf"
              # Also copy latexmk log for debugging
              cp -f "${out_dir}/${base}.log" "$dest_dir/${base}.log.txt" 2>/dev/null || true
              cp -f "$stdout_log" "$dest_dir/${base}.build.stdout.txt" 2>/dev/null || true
              cp -f "$stderr_log" "$dest_dir/${base}.build.stderr.txt" 2>/dev/null || true
              echo "  âœ“ ${dest_pdf}"
              ((++built))
            else
              echo "  âœ— FAILED: ${tex}"
              echo "    stdout: ${stdout_log#${GITHUB_WORKSPACE}/}"
              echo "    stderr: ${stderr_log#${GITHUB_WORKSPACE}/}"
              
              # Copy log files to build-logs for artifact upload
              cp -f "${out_dir}/${base}.log" "${log_dir}/${base}.log.txt" 2>/dev/null || true
              
              # Show immediate inline error summary
              echo ""
              echo "::group::Error details for ${base}.tex"
              
              # Show LaTeX errors from log file
              if [[ -f "${out_dir}/${base}.log" ]]; then
                echo "â”€â”€â”€ LaTeX Errors â”€â”€â”€"
                grep -n "^!" "${out_dir}/${base}.log" 2>/dev/null | head -20 || echo "(no explicit ! errors)"
                echo ""
                echo "â”€â”€â”€ Undefined References / Missing Files â”€â”€â”€"
                grep -iE "undefined|not found|missing" "${out_dir}/${base}.log" 2>/dev/null | head -15 || echo "(none)"
              fi
              
              # Show stderr if non-empty
              if [[ -s "$stderr_log" ]]; then
                echo ""
                echo "â”€â”€â”€ stderr â”€â”€â”€"
                head -30 "$stderr_log"
              fi
              
              echo "::endgroup::"
              
              failed_list+=("$tex")
              ((++failed))
            fi
          done

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "BUILD SUMMARY (${CATEGORY})"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Built:  ${built}"
          echo "Failed: ${failed}"

          if (( failed > 0 )); then
            printf '%s\n' "${failed_list[@]}" > "$GITHUB_WORKSPACE/collected-pdfs/${CATEGORY}/FAILED_BUILDS.txt" 2>/dev/null || true
          fi

          # Output count for visibility
          count=$(find "$GITHUB_WORKSPACE/collected-pdfs/${CATEGORY}" -name "*.pdf" -type f 2>/dev/null | wc -l | tr -d ' ' || echo 0)
          echo "count=$count" >> "$GITHUB_OUTPUT"
          echo "Collected $count PDFs under collected-pdfs/${CATEGORY}"

          # Fail the job if any build failed
          if (( failed > 0 )); then
            exit 1
          fi

      # ----------------------------------------------------------------------
      # Display detailed error logs for failed builds
      # ----------------------------------------------------------------------
      - name: Display failed build logs
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          
          CATEGORY="${{ matrix.category }}"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           DETAILED ERROR LOGS FOR FAILED BUILDS                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Category: ${CATEGORY}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Find all stderr files in build-logs
          shopt -s nullglob globstar
          
          for stderr_file in build-logs/**/*.build.stderr.txt; do
            [[ ! -f "$stderr_file" ]] && continue
            
            # Get corresponding stdout file
            stdout_file="${stderr_file%.stderr.txt}.stdout.txt"
            log_file="${stderr_file%.build.stderr.txt}.log.txt"
            
            # Extract the document name from path
            doc_path="${stderr_file#build-logs/}"
            doc_name="${doc_path%.build.stderr.txt}"
            
            # Check if this build actually failed (no corresponding PDF)
            pdf_check="collected-pdfs/${doc_name}.pdf"
            if [[ -f "$pdf_check" ]]; then
              continue  # Build succeeded, skip
            fi
            
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ FAILED: ${doc_name}.tex"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            
            # Show LaTeX log errors (most useful)
            latex_log="build-out/${doc_name}/${doc_name##*/}.log"
            if [[ -f "$latex_log" ]]; then
              echo ""
              echo "â”â”â” LaTeX Errors (from .log file) â”â”â”"
              # Extract error lines and surrounding context
              grep -n -A 5 -B 2 "^!" "$latex_log" 2>/dev/null | head -100 || echo "  (no explicit errors found)"
              echo ""
              echo "â”â”â” LaTeX Warnings â”â”â”"
              grep -i "warning" "$latex_log" 2>/dev/null | head -30 || echo "  (no warnings)"
              echo ""
              echo "â”â”â” Missing Files/Packages â”â”â”"
              grep -i "file.*not found\|package.*not found\|missing\|undefined" "$latex_log" 2>/dev/null | head -20 || echo "  (none detected)"
            fi
            
            # Show stderr (latexmk errors)
            if [[ -s "$stderr_file" ]]; then
              echo ""
              echo "â”â”â” Build stderr â”â”â”"
              cat "$stderr_file" | head -50
            fi
            
            # Show last part of stdout (latexmk output)
            if [[ -s "$stdout_file" ]]; then
              echo ""
              echo "â”â”â” Build stdout (last 50 lines) â”â”â”"
              tail -50 "$stdout_file"
            fi
            
            echo ""
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          done
          
          echo ""
          echo "For complete logs, download the 'build-error-logs-${{ matrix.category }}' artifact."

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-error-logs-${{ matrix.category }}
          path: |
            build-logs/
            build-out/**/*.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload category PDFs
        uses: actions/upload-artifact@v4
        with:
          name: pdfs-${{ matrix.category }}
          path: collected-pdfs
          retention-days: 7
          if-no-files-found: warn

  # ============================================================================
  # Stage 3: Aggregate all PDFs into single artifact
  # ============================================================================
  aggregate:
    needs: build
    if: always() && needs.build.result != 'cancelled'
    runs-on: ubuntu-latest
    outputs:
      total: ${{ steps.count.outputs.total }}
    steps:
      - name: Download all PDF artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pdfs-*
          path: all-pdfs
          merge-multiple: false

      - name: Merge PDFs
        id: count
        run: |
          set -euo pipefail
          
          echo "=== Downloaded artifacts ==="
          find all-pdfs -type d | head -30 || true
          
          mkdir -p merged-pdfs
          
          for artifact_dir in all-pdfs/pdfs-*/; do
            if [[ -d "$artifact_dir" ]]; then
              echo "Merging from: $artifact_dir"
              cp -r "$artifact_dir"/* merged-pdfs/ 2>/dev/null || true
            fi
          done
          
          echo ""
          echo "=== Merged structure ==="
          find merged-pdfs -type d | sort | head -50 || true
          
          total=$(find merged-pdfs -name "*.pdf" -type f 2>/dev/null | wc -l || echo 0)
          echo "total=$total" >> "$GITHUB_OUTPUT"
          echo ""
          echo "Total PDFs: $total"
          
          echo ""
          echo "=== All PDFs ==="
          find merged-pdfs -name "*.pdf" -type f | sort | head -100

      - name: Upload merged artifact
        if: inputs.upload-artifacts == true
        uses: actions/upload-artifact@v4
        with:
          name: latex-pdfs
          path: merged-pdfs
          retention-days: 30
          if-no-files-found: warn

      - name: Generate build summary
        run: |
          {
            echo "## ðŸ“„ LaTeX Build Summary"
            echo ""
            echo "**Total PDFs:** ${{ steps.count.outputs.total }}"
            echo ""
            echo "### By Category"
            echo ""
            for artifact_dir in all-pdfs/pdfs-*/; do
              if [[ -d "$artifact_dir" ]]; then
                category=$(basename "$artifact_dir" | sed 's/pdfs-//')
                count=$(find "$artifact_dir" -name "*.pdf" -type f 2>/dev/null | wc -l || echo 0)
                echo "- **$category**: $count PDFs"
              fi
            done
          } >> "$GITHUB_STEP_SUMMARY"
