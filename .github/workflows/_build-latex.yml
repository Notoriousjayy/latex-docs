# .github/workflows/_build-latex.yml
# Reusable workflow for building LaTeX documents
# Called by latex-ci.yml, latex-pages.yml, latex-release.yml
name: _Build LaTeX (Reusable)

on:
  workflow_call:
    inputs:
      build-all:
        description: 'Build all documents (ignore change detection)'
        type: boolean
        default: false
      document-category:
        description: 'Category filter (architecture, devops, security, etc.) or empty for all'
        type: string
        default: ''
      render-plantuml:
        description: 'Render PlantUML diagrams before building'
        type: boolean
        default: true
      upload-artifacts:
        description: 'Upload built PDFs as artifacts'
        type: boolean
        default: true
    outputs:
      pdf-count:
        description: 'Total PDFs built'
        value: ${{ jobs.aggregate.outputs.total }}
      artifact-name:
        description: 'Name of uploaded artifact'
        value: 'latex-pdfs'

jobs:
  # ============================================================================
  # Stage 1: Determine what changed and prepare build matrix
  # ============================================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
      plantuml-changed: ${{ steps.changes.outputs.plantuml }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: changes
        run: |
          set -euo pipefail
          
          # Force build-all if explicitly requested or workflow_dispatch
          if [[ "${{ inputs.build-all }}" == "true" ]]; then
            echo "Build-all requested"
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            echo "plantuml=true" >> "$GITHUB_OUTPUT"
            echo "changed-files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger - building everything"
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            echo "plantuml=true" >> "$GITHUB_OUTPUT"
            echo "changed-files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # Get changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "")
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi
          
          echo "Changed files:"
          echo "$CHANGED"
          
          TEX_CHANGES=$(echo "$CHANGED" | grep -E '\.tex$' || echo "")
          PUML_CHANGES=$(echo "$CHANGED" | grep -E '\.puml$' || echo "")
          WORKFLOW_CHANGES=$(echo "$CHANGED" | grep -E '\.github/' || echo "")
          TOOLING_CHANGES=$(echo "$CHANGED" | grep -E '^tooling/' || echo "")
          
          if [[ -n "$TEX_CHANGES" || -n "$PUML_CHANGES" || -n "$WORKFLOW_CHANGES" || -n "$TOOLING_CHANGES" || -z "$CHANGED" ]]; then
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
          fi
          
          if [[ -n "$PUML_CHANGES" || -n "$WORKFLOW_CHANGES" || -z "$CHANGED" ]]; then
            echo "plantuml=true" >> "$GITHUB_OUTPUT"
          else
            echo "plantuml=false" >> "$GITHUB_OUTPUT"
          fi
          
          printf 'changed-files<<EOF\n%s\nEOF\n' "$CHANGED" >> "$GITHUB_OUTPUT"

      - name: Build matrix of document categories
        id: matrix
        run: |
          set -euo pipefail
          
          CATEGORY="${{ inputs.document-category }}"
          
          if [[ -n "$CATEGORY" ]]; then
            echo "matrix={\"category\":[\"$CATEGORY\"]}" >> "$GITHUB_OUTPUT"
          else
            # Auto-discover categories from src/
            CATEGORIES=$(find src -mindepth 1 -maxdepth 1 -type d -exec basename {} \; 2>/dev/null | sort | jq -R . | jq -sc .)
            echo "Discovered categories: $CATEGORIES"
            echo "matrix={\"category\":$CATEGORIES}" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================================
  # Stage 2: Render PlantUML diagrams (if needed)
  # ============================================================================
  plantuml:
    needs: prepare
    if: needs.prepare.outputs.has-changes == 'true' && inputs.render-plantuml == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Render PlantUML
        uses: ./.github/actions/render-plantuml
        with:
          source-dir: src
          formats: 'png svg'

      - name: Upload rendered diagrams
        uses: actions/upload-artifact@v4
        with:
          name: plantuml-diagrams
          path: |
            src/**/png/*.png
            src/**/svg/*.svg
          retention-days: 1
          if-no-files-found: ignore

  # ============================================================================
  # Stage 3: Build documents in parallel by category
  # ============================================================================
  build:
    needs: [prepare, plantuml]
    if: always() && needs.prepare.outputs.has-changes == 'true' && (needs.plantuml.result == 'success' || needs.plantuml.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 6  # Limit concurrent jobs to avoid resource contention
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download PlantUML artifacts
        if: inputs.render-plantuml == true && needs.plantuml.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: plantuml-diagrams
          path: src
        continue-on-error: true

      - name: Setup LaTeX
        uses: ./.github/actions/setup-latex

      - name: Build ${{ matrix.category }} documents
        id: build
        uses: ./.github/actions/build-documents
        with:
          source-dir: src
          document-filter: 'src/${{ matrix.category }}/**/*.tex'
          build-all: ${{ inputs.build-all }}
          cache-aux-files: 'true'

      - name: Collect PDFs for upload
        run: |
          mkdir -p collected-pdfs/${{ matrix.category }}
          find src/${{ matrix.category }} -name "*.pdf" -type f -exec cp --parents {} collected-pdfs/ \; 2>/dev/null || true
          
          # Show what we collected
          echo "Collected PDFs:"
          find collected-pdfs -name "*.pdf" -type f | head -20

      - name: Upload category PDFs
        if: inputs.upload-artifacts == true
        uses: actions/upload-artifact@v4
        with:
          name: pdfs-${{ matrix.category }}
          path: collected-pdfs/src/${{ matrix.category }}
          retention-days: 14
          if-no-files-found: ignore

  # ============================================================================
  # Stage 4: Aggregate results
  # ============================================================================
  aggregate:
    needs: build
    if: always() && needs.build.result != 'cancelled'
    runs-on: ubuntu-latest
    outputs:
      total: ${{ steps.count.outputs.total }}
    steps:
      - name: Download all PDF artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pdfs-*
          path: all-pdfs
          merge-multiple: false

      - name: Organize and count PDFs
        id: count
        run: |
          # Flatten the category structure for easier access
          mkdir -p merged-pdfs
          
          # Each pdfs-* artifact has a category folder inside
          for category_dir in all-pdfs/pdfs-*/; do
            if [[ -d "$category_dir" ]]; then
              cp -r "$category_dir"/* merged-pdfs/ 2>/dev/null || true
            fi
          done
          
          total=$(find merged-pdfs -name "*.pdf" -type f 2>/dev/null | wc -l || echo 0)
          echo "total=$total" >> "$GITHUB_OUTPUT"
          echo "Total PDFs: $total"
          
          # List all PDFs
          echo ""
          echo "PDF listing:"
          find merged-pdfs -name "*.pdf" -type f | sort | head -50
          if [[ $total -gt 50 ]]; then
            echo "... and $((total - 50)) more"
          fi

      - name: Merge into single artifact
        if: inputs.upload-artifacts == true
        uses: actions/upload-artifact@v4
        with:
          name: latex-pdfs
          path: merged-pdfs
          retention-days: 30
          if-no-files-found: warn

      - name: Generate build summary
        run: |
          {
            echo "## LaTeX Build Summary"
            echo ""
            echo "**Total PDFs:** ${{ steps.count.outputs.total }}"
            echo ""
            echo "### By Category"
            echo ""
            for category_dir in all-pdfs/pdfs-*/; do
              if [[ -d "$category_dir" ]]; then
                category=$(basename "$category_dir" | sed 's/pdfs-//')
                count=$(find "$category_dir" -name "*.pdf" -type f 2>/dev/null | wc -l || echo 0)
                echo "- **$category**: $count PDFs"
              fi
            done
          } >> "$GITHUB_STEP_SUMMARY"
